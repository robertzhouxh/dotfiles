* Introduce
 use it, just clone this repo to whereever your emacs config is (usually =/home/$(USER)/.emacs.d=)
* Header
#+PROPERTY: header-args :results silent
* Custom Var
#+BEGIN_SRC emacs-lisp :tangle yes

  ; /usr/local/lib/erlang/lib/tools-{erlang-version}
  ; /usr/local/opt/erlang@23/lib/erlang/lib/tools-
  (setq erlang-version "3.5")
  (setq erlang-ls "/Users/glodon/githubs/erlang_ls/_build/default/bin/erlang_ls")
  (setq plantuml-path "/usr/local/Cellar/plantuml/1.2022.1/libexec/plantuml.jar")
  (setq centaur-proxy "127.0.0.1:8123")          ; HTTP/HTTPS proxy
  (setq centaur-socks-proxy "127.0.0.1:1080")    ; SOCKS proxy
  (setq centaur-server t)                        ; Enable `server-mode' or not: t or nil

#+END_SRC
* Bootstrap
#+BEGIN_SRC emacs-lisp :tangle yes
  ;; åŠ é€Ÿ
  (setq
   ;; ä¸è¦ç¼©æ”¾frame.
   frame-inhibit-implied-resize t
   ;; é»˜è®¤ç”¨æœ€ç®€å•çš„æ¨¡å¼
   initial-major-mode 'fundamental-mode
   ;; ä¸è¦è‡ªåŠ¨å¯ç”¨package
   package-enable-at-startup nil
   package--init-file-ensured t)

   ;; å¯åŠ¨
   (require 'package)
   (setq package-enable-at-startup nil)
   (setq package-archives '(("gnu" . "http://mirrors.163.com/elpa/gnu/")
                         ("melpa" . "https://melpa.org/packages/")
                         ("org" . "http://orgmode.org/elpa/")))
  ; (setq package-archives '(("melpa" . "http://elpa.emacs-china.org/melpa/")
	;		    ("org"   . "http://elpa.emacs-china.org/org/")
	;		    ("gnu"   . "http://elpa.emacs-china.org/gnu/")))

   (setq package-check-signature nil)
   (package-initialize)

   ;; Automatic package installation
   (mapc
    (lambda (package)
      (if (not (package-installed-p package))
	  (progn
	    (package-refresh-contents)
	    (package-install package))))
    '(use-package diminish bind-key))


   ;; trigger use-package, And force the install of missing packages.
   (eval-when-compile (require 'use-package))
   (require 'diminish)
   (require 'bind-key)

   (setq use-package-always-ensure t)
   (setq custom-file "~/.emacs.d/custom.el")
   (if (file-exists-p custom-file)
       (load custom-file))


   (defun add-subdirs-to-load-path (dir)
     "Recursive add directories to `load-path'."
     (let ((default-directory (file-name-as-directory dir)))
       (add-to-list 'load-path dir)
       (normal-top-level-add-subdirs-to-load-path)))

   (add-subdirs-to-load-path "~/.emacs.d/vendor/")

#+END_SRC
* Generic
#+BEGIN_SRC emacs-lisp :tangle yes

  ;; startup
  (tool-bar-mode -1)                      ;ç¦ç”¨å·¥å…·æ 
  (menu-bar-mode -1)                      ;ç¦ç”¨èœå•æ 
  (scroll-bar-mode -1)                    ;ç¦ç”¨æ»šåŠ¨æ¡

  (if (featurep 'cocoa)
      (progn
        ;; åœ¨Macå¹³å°, Emacsä¸èƒ½è¿›å…¥MacåŸç”Ÿçš„å…¨å±æ¨¡å¼,å¦åˆ™ä¼šå¯¼è‡´ `make-frame' åˆ›å»ºæ—¶ä¹Ÿé›†æˆåŸç”Ÿå…¨å±å±æ€§åé€ æˆç™½å±å’Œå·¦å³æ»‘åŠ¨ç°è±¡.
        ;; æ‰€ä»¥å…ˆè®¾ç½® `ns-use-native-fullscreen' å’Œ `ns-use-fullscreen-animation' ç¦æ­¢Emacsä½¿ç”¨MacåŸç”Ÿçš„å…¨å±æ¨¡å¼.
        ;; è€Œæ˜¯é‡‡ç”¨ä¼ ç»Ÿçš„å…¨å±æ¨¡å¼, ä¼ ç»Ÿçš„å…¨å±æ¨¡å¼, åªä¼šåœ¨å½“å‰å·¥ä½œåŒºå…¨å±,è€Œä¸æ˜¯åˆ‡æ¢åˆ°Macé‚£ç§å•ç‹¬çš„å…¨å±å·¥ä½œåŒº,
        ;; è¿™æ ·æ‰§è¡Œ `make-frame' å…ˆå…³ä»£ç æˆ–æ’ä»¶æ—¶,å°±ä¸ä¼šå› ä¸ºMacå•ç‹¬å·¥ä½œåŒºå·¦å³æ»‘åŠ¨äº§ç”Ÿçš„bug.
        ;;
        ;; Macå¹³å°ä¸‹,ä¸èƒ½ç›´æ¥ä½¿ç”¨ `set-frame-parameter' å’Œ `fullboth' æ¥è®¾ç½®å…¨å±,
        ;; é‚£æ ·ä¹Ÿä¼šå¯¼è‡´Macçª—å£ç®¡ç†å™¨ç›´æ¥æŠŠEmacsçª—å£æ‰”åˆ°å•ç‹¬çš„å·¥ä½œåŒº, ä»è€Œå¯¹ `make-frame' äº§ç”ŸåŒæ ·çš„Bug.
        ;; æ‰€ä»¥, å¯åŠ¨çš„æ—¶å€™é€šè¿‡ `set-frame-parameter' å’Œ `maximized' å…ˆè®¾ç½®Emacsä¸ºæœ€å¤§åŒ–çª—å£çŠ¶æ€, å¯åŠ¨5ç§’ä»¥åå†è®¾ç½®æˆå…¨å±çŠ¶æ€,
        ;; Macå°±ä¸ä¼šç§»åŠ¨Emacsçª—å£åˆ°å•ç‹¬çš„å·¥ä½œåŒº, æœ€ç»ˆè§£å†³Macå¹³å°ä¸‹åŸç”Ÿå…¨å±çª—å£å¯¼è‡´ `make-frame' å·¦å³æ»‘åŠ¨é—ªçƒçš„é—®é¢˜.
        (setq ns-use-native-fullscreen nil)
        (setq ns-use-fullscreen-animation nil)

        ;; é»˜è®¤å…ˆæœ€å¤§åŒ–ã€‚
        (set-frame-parameter (selected-frame) 'fullscreen 'maximized)

        (run-at-time "2sec" nil
                     (lambda ()
                       (toggle-frame-fullscreen)
                       ))
        )

    ;; éMacå¹³å°ç›´æ¥å…¨å±
    (require 'fullscreen)
    (fullscreen))

  ;; Code
  (prefer-coding-system 'utf-8)
  (setenv "LANG" "en_US.UTF-8")
  (setenv "LC_ALL" "en_US.UTF-8")
  (setenv "LC_CTYPE" "en_US.UTF-8")
  ;; Encoding
  ;; UTF-8 as the default coding system
  (when (fboundp 'set-charset-priority)
    (set-charset-priority 'unicode))
  
  ;; Explicitly set the prefered coding systems to avoid annoying prompt
  ;; from emacs (especially on Microsoft Windows)
  (prefer-coding-system 'utf-8)
  (setq locale-coding-system 'utf-8)
  
  (set-language-environment 'utf-8)
  (set-default-coding-systems 'utf-8)
  (set-buffer-file-coding-system 'utf-8)
  (set-clipboard-coding-system 'utf-8)
  (set-file-name-coding-system 'utf-8)
  (set-keyboard-coding-system 'utf-8)
  (set-terminal-coding-system 'utf-8)
  (set-selection-coding-system 'utf-8)
  (modify-coding-system-alist 'process "*" 'utf-8)

  ;; Restore emacs session.
  ;(setq initial-buffer-choice t)
  ;(run-with-timer 1 nil #'(lambda () (bury-buffer)))

  ;; å¢åŠ é•¿è¡Œå¤„ç†æ€§èƒ½
  (setq bidi-inhibit-bpa t)
  (setq-default bidi-paragraph-direction 'left-to-right)

  ;; å¢åŠ IOæ€§èƒ½
  (setq process-adaptive-read-buffering nil)
  (setq read-process-output-max (* 1024 1024))
  (setq make-backup-files nil) 

  (fset 'yes-or-no-p 'y-or-n-p)              ;ä»¥ y/nä»£è¡¨ yes/no
  (blink-cursor-mode -1)                     ;æŒ‡é’ˆä¸é—ªåŠ¨
  (transient-mark-mode 1)                    ;æ ‡è®°é«˜äº®
  (global-subword-mode 1)                    ;Wordç§»åŠ¨æ”¯æŒ FooBar çš„æ ¼å¼
  (setq use-dialog-box nil)                  ;never pop dialog
  ;(setq inhibit-startup-screen t)            ;inhibit start screen
  ;(setq initial-scratch-message "")          ;å…³é—­å¯åŠ¨ç©ºç™½buffer, è¿™ä¸ªbufferä¼šå¹²æ‰°sessionæ¢å¤
  (setq-default comment-style 'indent)       ;è®¾å®šè‡ªåŠ¨ç¼©è¿›çš„æ³¨é‡Šé£æ ¼
  (setq ring-bell-function 'ignore)          ;å…³é—­çƒ¦äººçš„å‡ºé”™æ—¶çš„æç¤ºå£°
  ;(setq default-major-mode 'text-mode)       ;è®¾ç½®é»˜è®¤åœ°ä¸»æ¨¡å¼ä¸ºTEXTæ¨¡å¼
  (setq mouse-yank-at-point t)               ;ç²˜è´´äºå…‰æ ‡å¤„,è€Œä¸æ˜¯é¼ æ ‡æŒ‡é’ˆå¤„
  (setq x-select-enable-clipboard t)         ;æ”¯æŒemacså’Œå¤–éƒ¨ç¨‹åºçš„ç²˜è´´
  (setq split-width-threshold nil)           ;åˆ†å±çš„æ—¶å€™ä½¿ç”¨ä¸Šä¸‹åˆ†å±
  (setq inhibit-compacting-font-caches t)    ;ä½¿ç”¨å­—ä½“ç¼“å­˜ï¼Œé¿å…å¡é¡¿
  (setq confirm-kill-processes nil)          ;é€€å‡ºè‡ªåŠ¨æ€æ‰è¿›ç¨‹
  (setq async-bytecomp-allowed-packages nil) ;é¿å…magitæŠ¥é”™
  (setq word-wrap-by-category t)             ;æŒ‰ç…§ä¸­æ–‡æŠ˜è¡Œ
  (setq profiler-report-cpu-line-format      ;è®© profiler-report ç¬¬ä¸€åˆ—å®½ä¸€ç‚¹
        '((100 left)
          (24 right ((19 right)
                     (5 right)))))
  (setq profiler-report-memory-line-format
        '((100 left)
          (19 right ((14 right profiler-format-number)
                     (5 right)))))

  (setq ad-redefinition-action 'accept)   ;ä¸è¦çƒ¦äººçš„ redefine warning
  (setq frame-resize-pixelwise t)         ;è®¾ç½®ç¼©æ”¾çš„æ¨¡å¼,é¿å…Macå¹³å°æœ€å¤§åŒ–çª—å£ä»¥åå³è¾¹å’Œä¸‹è¾¹æœ‰ç©ºéš™

  ;; å¹³æ»‘åœ°è¿›è¡ŒåŠå±æ»šåŠ¨ï¼Œé¿å…æ»šåŠ¨årecenteræ“ä½œ
  (setq-default scroll-step 1
  	    scroll-preserve-screen-position t
  	    scroll-up-aggressively 0.01
  	    scroll-down-aggressively 0.01
  	    redisplay-dont-pause t
  	    auto-window-vscroll nil
  	    ;; Mouse wheel scroll behavior
  	    mouse-wheel-scroll-amount '(1 ((shift) . 1))
  	    mouse-wheel-progressive-speed nil
  	    mouse-wheel-follow-mouse 't
  	    fast-but-imprecise-scrolling nil)

  ;; ä¸æ˜¾ç¤º *scratch*
  ;(defun remove-scratch-buffer ()
  ;  (if (get-buffer "*scratch*")
  ;      (kill-buffer "*scratch*")))
  ;(add-hook 'after-change-major-mode-hook 'remove-scratch-buffer)

  ;;; Don't ask me when close emacs with process is running
  ;(defadvice save-buffers-kill-emacs (around no-query-kill-emacs activate)
  ;  "Prevent annoying \"Active processes exist\" query when you quit Emacs."
  ;  (require 'noflet)
  ;  (noflet ((process-list ())) ad-do-it))

  ;;; Don't ask me when kill process buffer
  ;(setq kill-buffer-query-functions
  ;      (remq 'process-kill-buffer-query-function
  ;            kill-buffer-query-functions))

  ;; idle
  (custom-set-variables '(tramp-verbose 0)) ;è®¾ç½®trampçš„å“åº”æ–¹å¼, å…³é—­åä¸å¼¹å‡ºæ¶ˆæ¯
  (setq max-lisp-eval-depth 40000)          ;lispæœ€å¤§æ‰§è¡Œæ·±åº¦
  (setq max-specpdl-size 10000)             ;æœ€å¤§å®¹é‡
  (setq kill-ring-max 1024)                 ;ç”¨ä¸€ä¸ªå¾ˆå¤§çš„ kill ring. è¿™æ ·é˜²æ­¢æˆ‘ä¸å°å¿ƒåˆ æ‰é‡è¦çš„ä¸œè¥¿
  (setq mark-ring-max 1024)                 ;è®¾ç½®çš„mark ringå®¹é‡
  (setq eval-expression-print-length nil)   ;è®¾ç½®æ‰§è¡Œè¡¨è¾¾å¼çš„é•¿åº¦æ²¡æœ‰é™åˆ¶
  (setq eval-expression-print-level nil)    ;è®¾ç½®æ‰§è¡Œè¡¨è¾¾å¼çš„æ·±åº¦æ²¡æœ‰é™åˆ¶
  (auto-compression-mode 1)                 ;æ‰“å¼€å‹ç¼©æ–‡ä»¶æ—¶è‡ªåŠ¨è§£å‹ç¼©
  (setq read-quoted-char-radix 16)          ;è®¾ç½® å¼•ç”¨å­—ç¬¦ çš„åŸºæ•°
  (setq global-mark-ring-max 1024)          ;è®¾ç½®æœ€å¤§çš„å…¨å±€æ ‡è®°å®¹é‡
  (global-hl-line-mode 1)                   ;é«˜äº®å½“å‰è¡Œ
  (setq isearch-allow-scroll t)             ;isearchæœç´¢æ—¶æ˜¯å¯ä»¥æ»šåŠ¨å±å¹•çš„
  (setq one-key-popup-window nil)           ;ç¦æ­¢è‡ªåŠ¨å¼¹å‡ºçª—å£
  (setq enable-recursive-minibuffers t)     ;minibuffer é€’å½’è°ƒç”¨å‘½ä»¤
  (setq history-delete-duplicates t)        ;åˆ é™¤minibufferçš„é‡å¤å†å²
  (setq minibuffer-message-timeout 1)       ;æ˜¾ç¤ºæ¶ˆæ¯è¶…æ—¶çš„æ—¶é—´
  (setq auto-revert-mode 1)                 ;è‡ªåŠ¨æ›´æ–°buffer
  (show-paren-mode t)                       ;æ˜¾ç¤ºæ‹¬å·åŒ¹é…
  (setq show-paren-style 'parentheses)      ;æ‹¬å·åŒ¹é…æ˜¾ç¤ºä½†ä¸æ˜¯çƒ¦äººçš„è·³åˆ°å¦ä¸€ä¸ªæ‹¬å·ã€‚
  (setq blink-matching-paren nil)           ;å½“æ’å…¥å³æ‹¬å·æ—¶ä¸æ˜¾ç¤ºåŒ¹é…çš„å·¦æ‹¬å·
  (setq message-log-max t)                  ;è®¾ç½®messageè®°å½•å…¨éƒ¨æ¶ˆæ¯, è€Œä¸ç”¨æˆªå»
  (setq require-final-newline nil)          ;ä¸è‡ªåŠ¨æ·»åŠ æ¢è¡Œç¬¦åˆ°æœ«å°¾, æœ‰äº›æƒ…å†µä¼šå‡ºç°é”™è¯¯
  (setq ediff-window-setup-function (quote ediff-setup-windows-plain)) ;æ¯”è¾ƒçª—å£è®¾ç½®åœ¨åŒä¸€ä¸ªframeé‡Œ
  (setq x-stretch-cursor t)                 ;å…‰æ ‡åœ¨ TAB å­—ç¬¦ä¸Šä¼šæ˜¾ç¤ºä¸ºä¸€ä¸ªå¤§æ–¹å—
  (put 'narrow-to-region 'disabled nil)     ;å¼€å¯å˜çª„åŒºåŸŸ
  (setq print-escape-newlines t)            ;æ˜¾ç¤ºå­—ç¬¦çª—ä¸­çš„æ¢è¡Œç¬¦ä¸º \n
  (setq tramp-default-method "ssh")         ;è®¾ç½®ä¼ é€æ–‡ä»¶é»˜è®¤çš„æ–¹æ³•
  (setq void-text-area-pointer nil)         ;ç¦æ­¢æ˜¾ç¤ºé¼ æ ‡æŒ‡é’ˆ
  (setq byte-compile-warnings
        (quote (
                ;; æ˜¾ç¤ºçš„è­¦å‘Š
                free-vars                   ;ä¸åœ¨å½“å‰èŒƒå›´çš„å¼•ç”¨å˜é‡
                unresolved                  ;ä¸çŸ¥é“çš„å‡½æ•°
                callargs                    ;å‡½æ•°è°ƒç”¨çš„å‚æ•°å’Œå®šä¹‰çš„ä¸åŒ¹é…
                obsolete                    ;è’åºŸçš„å˜é‡å’Œå‡½æ•°
                noruntime                   ;å‡½æ•°æ²¡æœ‰å®šä¹‰åœ¨è¿è¡Œæ—¶æœŸ
                interactive-only            ;æ­£å¸¸ä¸è¢«è°ƒç”¨çš„å‘½ä»¤
                make-local ;è°ƒç”¨ `make-variable-buffer-local' å¯èƒ½ä¼šä¸æ­£ç¡®çš„
                mapcar     ;`mapcar' è°ƒç”¨
                ;;
                ;; æŠ‘åˆ¶çš„è­¦å‘Š
                (not redefine)              ;é‡æ–°å®šä¹‰çš„å‡½æ•° (æ¯”å¦‚å‚æ•°æ•°é‡æ”¹å˜)
                ;(not cl-functions)          ;`CL' åŒ…ä¸­çš„è¿è¡Œæ—¶è°ƒç”¨çš„å‡½æ•°
                )))
  (setq echo-keystrokes 0.1)                ;åŠ å¿«å¿«æ·é”®æç¤ºçš„é€Ÿåº¦
  (tooltip-mode -1)                         ;ä¸è¦æ˜¾ç¤ºä»»ä½• tooltips

#+END_SRC
* Const
#+BEGIN_SRC emacs-lisp :tangle yes

    (defconst centaur-homepage
      "https://github.com/robertzhouxh/dotfiles"
      "The Github page of my Emacs.")

    (defconst centaur-custom-example-file
      (expand-file-name "custom-example.el" user-emacs-directory)
      "Custom example file of Centaur Emacs.")

    (defconst centaur-custom-post-file
      (expand-file-name "custom-post.el" user-emacs-directory)
      "Custom file after startup.

    Put private configurations to override defaults here.")

    (defconst centaur-custom-post-org-file
      (expand-file-name "custom-post.org" user-emacs-directory)
      "Custom org file after startup.

    Put private configurations to override defaults here.
    Loaded by `org-babel-load-file'.")

    (defconst sys/win32p
      (eq system-type 'windows-nt)
      "Are we running on a WinTel system?")

    (defconst sys/linuxp
      (eq system-type 'gnu/linux)
      "Are we running on a GNU/Linux system?")

    (defconst sys/macp
      (eq system-type 'darwin)
      "Are we running on a Mac system?")

    (defconst sys/mac-x-p
      (and (display-graphic-p) sys/macp)
      "Are we running under X on a Mac system?")

    (defconst sys/mac-ns-p
      (eq window-system 'ns)
      "Are we running on a GNUstep or Macintosh Cocoa display?")

    (defconst sys/mac-cocoa-p
      (featurep 'cocoa)
      "Are we running with Cocoa on a Mac system?")

    (defconst sys/mac-port-p
      (eq window-system 'mac)
      "Are we running a macport build on a Mac system?")

    (defconst sys/linux-x-p
      (and (display-graphic-p) sys/linuxp)
      "Are we running under X on a GNU/Linux system?")

    (defconst sys/cygwinp
      (eq system-type 'cygwin)
      "Are we running on a Cygwin system?")

    (defconst sys/rootp
      (string-equal "root" (getenv "USER"))
      "Are you using ROOT user?")

    (defconst emacs/>=25p
      (>= emacs-major-version 25)
      "Emacs is 25 or above.")

    (defconst emacs/>=26p
      (>= emacs-major-version 26)
      "Emacs is 26 or above.")

    (defconst emacs/>=27p
      (>= emacs-major-version 27)
      "Emacs is 27 or above.")

    (defconst emacs/>=25.3p
      (or emacs/>=26p
	  (and (= emacs-major-version 25) (>= emacs-minor-version 3)))
      "Emacs is 25.3 or above.")

    (defconst emacs/>=25.2p
      (or emacs/>=26p
	  (and (= emacs-major-version 25) (>= emacs-minor-version 2)))
      "Emacs is 25.2 or above.")

    (defconst emacs/>=27p
      (>= emacs-major-version 27)
      "Emacs is 27 or above.")

    (defconst emacs/>=28p
      (>= emacs-major-version 28)
      "Emacs is 28 or above.")

    (defconst emacs/>=29p
      (>= emacs-major-version 29)
      "Emacs is 29 or above.")

  ;; Suppress warnings
    (defvar socks-noproxy)
    (defvar socks-server)
    (defcustom centaur-proxy "127.0.0.1:8123"
      "Set network proxy."
      :group 'centaur
      :type 'string)

  (defcustom centaur-prettify-symbols-alist
    '(("lambda" . ?Î»)
      ("<-"     . ?â†)
      ("->"     . ?â†’)
      ("->>"    . ?â† )
      ("=>"     . ?â‡’)
      ("map"    . ?â†¦)
      ("/="     . ?â‰ )
      ("!="     . ?â‰ )
      ("=="     . ?â‰¡)
      ("<="     . ?â‰¤)
      (">="     . ?â‰¥)
      ("=<<"    . (?= (Br . Bl) ?â‰ª))
      (">>="    . (?â‰« (Br . Bl) ?=))
      ("<=<"    . ?â†¢)
      (">=>"    . ?â†£)
      ("&&"     . ?âˆ§)
      ("||"     . ?âˆ¨)
      ("not"    . ?Â¬))
    "A list of symbol prettifications.
  Nil to use font supports ligatures."
    :group 'centaur
    :type '(alist :key-type string :value-type (choice character sexp)))
  
  (defcustom centaur-prettify-org-symbols-alist
    '(("[ ]" . ?â˜)
      ("[X]" . ?â˜‘)
      ("[-]" . ?â›)
  
      ("#+ARCHIVE:"     . ?ğŸ“¦)
      ("#+AUTHOR:"      . ?ğŸ‘¤)
      ("#+CREATOR:"     . ?ğŸ’)
      ("#+DATE:"        . ?ğŸ“†)
      ("#+DESCRIPTION:" . ?â¸™)
      ("#+EMAIL:"       . ?ğŸ“§)
      ("#+OPTIONS:"     . ?â›­)
      ("#+SETUPFILE:"   . ?â›®)
      ("#+TAGS:"        . ?ğŸ·)
      ("#+TITLE:"       . ?ğŸ““)
  
      ("#+BEGIN_SRC"   . ?âœ)
      ("#+END_SRC"     . ?â–¡)
      ("#+BEGIN_QUOTE" . ?Â»)
      ("#+END_QUOTE"   . ?Â«)
      ("#+HEADERS"     . ?â˜°)
      ("#+RESULTS:"    . ?ğŸ’»))
    "A list of symbol prettifications for `org-mode'."
    :group 'centaur
    :type '(alist :key-type string :value-type (choice character sexp)))

#+END_SRC
* Functions
#+BEGIN_SRC emacs-lisp :tangle yes
  ;;; https://emacs-china.org/t/org-mode/79
  (defun my-org-screenshot ()
    "Take a screenshot into a time stamped unique-named file in the
    same directory as the org-buffer and insert a link to this file."
    (interactive)
    (org-display-inline-images)

    (setq filename
	  (concat
	   (make-temp-name
	    (concat (file-name-directory (buffer-file-name))
		    "/imgs/"
		    (format-time-string "%Y%m%d_%H%M%S_")) ) ".png"))
    (unless (file-exists-p (file-name-directory filename))
      (make-directory (file-name-directory filename)))
					  ; take screenshot
    (if (eq system-type 'darwin)
	(progn
	  (call-process-shell-command "screencapture" nil nil nil nil " -s " (concat
									      "\"" filename "\"" ))
	  (call-process-shell-command "convert" nil nil nil nil (concat "\"" filename "\" -resize  \"50%\"" ) (concat "\"" filename "\"" ))
	  ))

    (setq relative-dir (concat "./imgs/" (file-name-nondirectory filename)))
    (if (file-exists-p filename)
	(insert (concat "[[file:" relative-dir "]]")))
    (org-display-inline-images)
    )

  (defun x/save-all ()
    "Save all file-visiting buffers without prompting."
    (interactive)
    (save-some-buffers t))

  (defun x/open-init-file ()
    (interactive)
    (find-file user-init-file))

  (defun x/reload-init-file ()
    "Reload init.el file."
    (interactive)
    (load user-init-file)
    (message "Reloaded init.el OK."))

  (defun x/system-is-mac ()
    (interactive)
    (string-equal system-type "darwin"))

  (defun x/system-is-linux ()
    (interactive)
    (string-equal system-type "gnu/linux"))

  (defun hold-line-scroll-up ()
    "Scroll the page with the cursor in the same line"
    (interactive)
    ;; move the cursor also
    (let ((tmp (current-column)))
      (scroll-up 1)
      (line-move-to-column tmp)
      (forward-line 1)))

  (defun hold-line-scroll-down ()
    "Scroll the page with the cursor in the same line"
    (interactive)
    ;; move the cursor also
    (let ((tmp (current-column)))
      (scroll-down 1)
      (line-move-to-column tmp)
      (forward-line -1)))

  (defun scan-code-tags ()
    "Scan code tags: @TODO: , @FIXME:, @BUG:, @NOTE:."
    (interactive)
    (split-window-horizontally)
    (occur "@FIXME:\\|@TODO:\\|@BUG:\\|@NOTE:"))

  (defun select-current-word ()
    "Select the word under cursor.
	â€œwordâ€ here is considered any alphanumeric sequence with â€œ_â€ or â€œ-â€."
    (interactive)
    (let (pt)
      (skip-chars-backward "-_A-Za-z0-9")
      (setq pt (point))
      (skip-chars-forward "-_A-Za-z0-9")
      (set-mark pt)))

  ;; Insert Src Block
  (use-package ido-completing-read+)
  (defun pkg-insert-src-block (src-code-type)
    "Insert a `SRC-CODE-TYPE' type source code block in org-mode."
    (interactive
     (let ((src-code-types
	    '("emacs-lisp" "python" "C" "sh" "java" "js" "clojure" "C++" "css"
	      "calc" "asymptote" "dot" "gnuplot" "ledger" "lilypond" "mscgen"
	      "octave" "oz" "plantuml" "R" "sass" "screen" "sql" "awk" "ditaa"
	      "haskell" "latex" "lisp" "matlab" "ocaml" "org" "perl" "ruby"
	      "scheme" "sqlite" "html")))
       (list (ido-completing-read+ "Source code type: " src-code-types))))
    (progn
      (newline-and-indent)
      (insert (format "#+BEGIN_SRC %s\n" src-code-type))
      (newline-and-indent)
      (insert "#+END_SRC\n")
      (previous-line 2)
      (org-edit-src-code)))

  (defun sudo ()
    "Use TRAMP to `sudo' the current buffer"
    (interactive)
    (when buffer-file-name
      (find-alternate-file
       (concat "/sudo:root@localhost:"
	       buffer-file-name))))

  (defun rename-local-var (name)
    (interactive "sEnter new name: ")
    (let ((var (word-at-point)))
      (mark-defun)
      (replace-string var name nil (region-beginning) (region-end))))

  (defun format-function-parameters ()
    "Turn the list of function parameters into multiline."
    (interactive)
    (beginning-of-line)
    (search-forward "(" (line-end-position))
    (newline-and-indent)
    (while (search-forward "," (line-end-position) t)
      (newline-and-indent))
    (end-of-line)
    (c-hungry-delete-forward)
    (insert " ")
    (search-backward ")")
    (newline-and-indent))

    ;;;;;;;;;;;;;;;;;;;;;;;; File and buffer ;;;;;;;;;;;;;;;;;;;;;;;
  (defun revert-this-buffer ()
    "Revert the current buffer."
    (interactive)
    (unless (minibuffer-window-active-p (selected-window))
      (revert-buffer t t)
      (message "Reverted this buffer")))
  (global-set-key (kbd "s-r") #'revert-this-buffer)

  (defun delete-this-file ()
    "Delete the current file, and kill the buffer."
    (interactive)
    (unless (buffer-file-name)
      (error "No file is currently being edited"))
    (when (yes-or-no-p (format "Really delete '%s'?"
			       (file-name-nondirectory buffer-file-name)))
      (delete-file (buffer-file-name))
      (kill-this-buffer)))
  (global-set-key (kbd "C-x K") #'delete-this-file)

  (defun rename-this-file (new-name)
    "Renames both current buffer and file it's visiting to NEW-NAME."
    (interactive "sNew name: ")
    (let ((name (buffer-name))
	  (filename (buffer-file-name)))
      (unless filename
	(error "Buffer '%s' is not visiting a file!" name))
      (progn
	(when (file-exists-p filename)
	  (rename-file filename new-name 1))
	(set-visited-file-name new-name)
	(rename-buffer new-name))))

  (defun create-scratch-buffer ()
    "Create a scratch buffer."
    (interactive)
    (switch-to-buffer (get-buffer-create "*scratch*"))
    (lisp-interaction-mode))

    ;;;;;;;;;;;;;;;;;;;;;;;;; Font ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

  ;; Dos2Unix/Unix2Dos
  (defun dos2unix ()
    "Convert the current buffer to UNIX file format."
    (interactive)
    (set-buffer-file-coding-system 'undecided-unix nil))

  (defun unix2dos ()
    "Convert the current buffer to DOS file format."
    (interactive)
    (set-buffer-file-coding-system 'undecided-dos nil))

  (defun delete-carrage-returns ()
    "Delete `^M' characters in the buffer.
      Same as `replace-string C-q C-m RET RET'."
    (interactive)
    (save-excursion
      (goto-char 0)
      (while (search-forward "\r" nil :noerror)
	(replace-match ""))))

  (defun save-buffer-as-utf8 (coding-system)
    "Revert a buffer with `CODING-SYSTEM' and save as UTF-8."
    (interactive "zCoding system for visited file (default nil):")
    (revert-buffer-with-coding-system coding-system)
    (set-buffer-file-coding-system 'utf-8)
    (save-buffer))

  (defun save-buffer-gbk-as-utf8 ()
    "Revert a buffer with GBK and save as UTF-8."
    (interactive)
    (save-buffer-as-utf8 'gbk))

    ;;;;;;;;;;;;;;;;;;;;;; Network Proxy ;;;;;;;;;;;;;;;;;;;;;;;;;;
  ;; Network Proxy
  (defun proxy-http-show ()
    "Show HTTP/HTTPS proxy."
    (interactive)
    (if url-proxy-services
	(message "Current HTTP proxy is `%s'" centaur-proxy)
      (message "No HTTP proxy")))

  (defun proxy-http-enable ()
    "Enable HTTP/HTTPS proxy."
    (interactive)
    (setq url-proxy-services
	  `(("http" . ,centaur-proxy)
	    ("https" . ,centaur-proxy)
	    ("no_proxy" . "^\\(localhost\\|192.168.*\\|10.*\\)")))
    (proxy-http-show))

  (defun proxy-http-disable ()
    "Disable HTTP/HTTPS proxy."
    (interactive)
    (setq url-proxy-services nil)
    (proxy-http-show))

  (defun proxy-http-toggle ()
    "Toggle HTTP/HTTPS proxy."
    (interactive)
    (if (bound-and-true-p url-proxy-services)
	(proxy-http-disable)
      (proxy-http-enable)))

  (defun proxy-socks-show ()
    "Show SOCKS proxy."
    (interactive)
    (when (fboundp 'cadddr)                ; defined 25.2+
      (if (bound-and-true-p socks-noproxy)
	  (message "Current SOCKS%d proxy is %s:%s"
		   (cadddr socks-server) (cadr socks-server) (caddr socks-server))
	(message "No SOCKS proxy"))))

  (defun proxy-socks-enable ()
    "Enable SOCKS proxy."
    (interactive)
    (require 'socks)
    (setq url-gateway-method 'socks
	  socks-noproxy '("localhost"))
    (let* ((proxy (split-string centaur-socks-proxy ":"))
	   (host (car proxy))
	   (port (cadr  proxy)))
      (setq socks-server `("Default server" ,host ,port 5)))
    (setenv "all_proxy" (concat "socks5://" centaur-socks-proxy))
    (proxy-socks-show))

  (defun proxy-socks-disable ()
    "Disable SOCKS proxy."
    (interactive)
    (setq url-gateway-method 'native
	  socks-noproxy nil
	  socks-server nil)
    (setenv "all_proxy" "")
    (proxy-socks-show))

  (defun proxy-socks-toggle ()
    "Toggle SOCKS proxy."
    (interactive)
    (if (bound-and-true-p socks-noproxy)
	(proxy-socks-disable)
      (proxy-socks-enable)))

  (defun org-export-docx ()
    (interactive)
    (let ((docx-file (concat (file-name-sans-extension (buffer-file-name)) ".docx"))
	  (template-file "/Users/glodon/githubs/dotfiles/.emacs.d/template.docx"))
      (shell-command (format "pandoc %s -o %s --reference-doc=%s" (buffer-file-name) docx-file template-file))
      (message "Convert finish: %s" docx-file)))
#+END_SRC
* Plugins
#+BEGIN_SRC emacs-lisp :tangle yes
  (use-package use-package-ensure-system-package :ensure t)

  ;; Environment
  (use-package exec-path-from-shell
    :ensure t
    :if (or sys/mac-x-p sys/linux-x-p)
    :config
    (setq exec-path-from-shell-variables '("PATH" "GOPATH"))
    (setq exec-path-from-shell-arguments '("-l"))
    (exec-path-from-shell-initialize))

  (use-package json-reformat)
  (use-package comment-dwim-2)
  (use-package buffer-flip)
  (use-package markdown-mode)
  (use-package dockerfile-mode)
  (use-package json-mode)
  (use-package protobuf-mode)
  (use-package async :ensure t :init (async-bytecomp-package-mode 1))
  (use-package projectile :diminish :config (projectile-global-mode))
  (use-package flycheck :diminish :config (global-flycheck-mode 1))
  (use-package swiper :ensure t :bind (("C-s" . swiper)))
  (use-package restclient
    :config
    ;; since `url-cookies-list' is lack of flexibility
    (setq restclient-inhibit-cookies t))
  (use-package company-restclient)
  (use-package nginx-mode :ensure t)
  (use-package company-nginx
    :after (nginx-mode)
    :hook((nginx-mode . company-nginx-keywords))
    :config)
  ;(use-package edwina
  ;  :config
  ;  (setq display-buffer-base-action '(display-buffer-below-selected))
  ;  (edwina-setup-dwm-keys)
  ;  (edwina-mode 1))

  (use-package avy
    :bind
    (("C-c SPC" . avy-goto-char-2)
     ("M-g f" . avy-goto-line)
     ("M-g w" . avy-goto-word-1)))

  (use-package which-key
    :diminish which-key-mode
    :hook (after-init . which-key-mode)
    :config
    (progn
      (which-key-mode)
      (which-key-setup-side-window-right)))

  (use-package volatile-highlights
    :ensure t
    :diminish
    :hook
    (after-init . volatile-highlights-mode)
    :custom-face
    (vhl/default-face ((nil (:foreground "#FF3333" :background "#FFCDCD")))))

					  ;(use-package undo-tree
					  ;  :ensure t
					  ;  :diminish
					  ;  :config
					  ;  (progn
					  ;    (global-undo-tree-mode)
					  ;    (setq undo-tree-visualizer-timestamps t)
					  ;    (setq undo-tree-visualizer-diff t)
					  ;    ))

  (use-package multiple-cursors
    :bind (("C-S-c" . mc/edit-lines) ;; æ¯è¡Œä¸€ä¸ªå…‰æ ‡
	   ("C->" . mc/mark-next-like-this-symbol) ;; å…¨é€‰å…‰æ ‡æ‰€åœ¨å•è¯å¹¶åœ¨ä¸‹ä¸€ä¸ªå•è¯å¢åŠ ä¸€ä¸ªå…‰æ ‡ã€‚é€šå¸¸ç”¨æ¥å¯åŠ¨ä¸€ä¸ªæµç¨‹
	   ("C-M->" . mc/skip-to-next-like-this) ;; è·³è¿‡å½“å‰å•è¯å¹¶è·³åˆ°ä¸‹ä¸€ä¸ªå•è¯ï¼Œå’Œä¸Šé¢åœ¨åŒä¸€ä¸ªæµç¨‹é‡Œã€‚
	   ("C-<" . mc/mark-previous-like-this-symbol) ;; åŒæ ·æ˜¯å¼€å¯ä¸€ä¸ªå¤šå…‰æ ‡æµç¨‹ï¼Œä½†æ˜¯æ˜¯ã€Œå‘ä¸Šæ‰¾ã€è€Œä¸æ˜¯å‘ä¸‹æ‰¾ã€‚
	   ("C-M-<" . mc/skip-to-previous-like-this) ;; è·³è¿‡å½“å‰å•è¯å¹¶è·³åˆ°ä¸Šä¸€ä¸ªå•è¯ï¼Œå’Œä¸Šé¢åœ¨åŒä¸€ä¸ªæµç¨‹é‡Œã€‚
	   ("C-c C->" . mc/mark-all-symbols-like-this))) ;; ç›´æ¥å¤šé€‰æœ¬ buffer æ‰€æœ‰è¿™ä¸ªå•è¯

  (use-package paredit
    :diminish paredit-mode
    :init
    (defun override-slime-del-key ()
      (define-key slime-repl-mode-map
      (read-kbd-macro paredit-backward-delete-key) nil))
    (add-hook 'emacs-lisp-mode-hook 'enable-paredit-mode)
    (add-hook 'eval-expression-minibuffer-setup-hook 'enable-paredit-mode)
    (add-hook 'ielm-mode-hook 'enable-paredit-mode)
    (add-hook 'lisp-mode-hook 'enable-paredit-mode)
    (add-hook 'lisp-interaction-mode-hook 'enable-paredit-mode)
    (add-hook 'slime-repl-mode-hook 'enable-paredit-mode)
    (add-hook 'slime-repl-mode-hook 'override-slime-del-key)
    (add-hook 'erlang-mode-hook 'enable-paredit-mode)
    (add-hook 'go-mode-hook 'paredit-mode)
    )

  (use-package rainbow-delimiters
    :ensure t
    :init (add-hook 'prog-mode-hook #'rainbow-delimiters-mode))

  (use-package yasnippet
    :ensure t
    :config
    (yas-global-mode 1))

  ;; å†è£…ä¸€ä¸ªé€šç”¨æ¨¡æ¿åº“ï¼Œçœå¾—æ²¡ template ç”¨
  (use-package yasnippet-snippets
    :ensure t
    :after (yasnippet))

  ;; æ¨¡æ¿ç”Ÿæˆå·¥å…·ï¼Œå†™ä»£ç æ—¶éšæ‰‹ç”Ÿæˆä¸€ä¸ªæ¨¡æ¿ã€‚å¼ºçƒˆæ¨èä½¿ç”¨
  ;; ä½¿ç”¨æ–¹æ³•ï¼š https://github.com/abo-abo/auto-yasnippet#usage
  (use-package auto-yasnippet
    :ensure t
    :bind
    (("C-c & w" . aya-create)
     ("C-c & y" . aya-expand))
    :config
    (setq aya-persist-snippets-dir (concat user-emacs-directory "my/snippets")))

  (use-package ag
    :defer t
    :config
    (progn
      (setq ag-highlight-search t)
      (bind-key "n" 'compilation-next-error ag-mode-map)
      (bind-key "p" 'compilation-previous-error ag-mode-map)
      (bind-key "N" 'compilation-next-file ag-mode-map)
      (bind-key "P" 'compilation-previous-file ag-mode-map)))

  (use-package ivy
    :diminish ivy-mode
    :ensure t
    :preface (eval-when-compile (declare-function ivy-mode nil))
    :init (setq ivy-use-virtual-buffers t)
    :config (ivy-mode t))

  ;; Cross-referencing commands
;  (use-package xref
;    :ensure nil
;    :init
;    (when (executable-find "rg")
;      (setq xref-search-program 'ripgrep))
;  
;    (with-no-warnings
;      ;; Select from xref candidates with Ivy
;      (if emacs/>=28p
;          (setq xref-show-definitions-function #'xref-show-definitions-completing-read
;                xref-show-xrefs-function #'xref-show-definitions-completing-read)
;        (use-package ivy-xref
;          :after ivy
;          :init
;          (when emacs/>=27p
;            (setq xref-show-definitions-function #'ivy-xref-show-defs))
;          (setq xref-show-xrefs-function #'ivy-xref-show-xrefs)))))


  (use-package counsel
    :after ivy
    :diminish counsel-mode
    :init
    (add-to-list 'ivy-ignore-buffers "^#")
    (add-to-list 'ivy-ignore-buffers "^\\*irc\\-")
    )
  (use-package counsel-projectile
    :after (counsel projectile)
    :diminish counsel-projectile-mode
    :preface
    (eval-when-compile
      (declare-function counsel-projectile-mode nil))
    :commands
    (counsel-projectile-rg
     counsel-projectile-find-file
     counsel-projectile-switch-project
     counsel-projectile-switch-to-buffer)
    :init
    (with-eval-after-load 'evil-leader
      (evil-leader/set-key
	"p/" 'counsel-projectile-rg
	"pf" 'counsel-projectile-find-file
	"pp" 'counsel-projectile-switch-project
	"pb" 'counsel-projectile-switch-to-buffer))
    :config
    (counsel-projectile-mode t))


  ;; Automatically reload files was modified by external program
  (use-package autorevert
    :ensure nil
    :diminish
    :hook (after-init . global-auto-revert-mode))

  ;; Jump
  (use-package dumb-jump
    :diminish dumb-jump-mode
    :config
    (setq dumb-jump-aggressive nil)
    (setq dumb-jump-selector 'ivy)
    (setq dumb-jump-prefer-searcher 'ag))

  (use-package key-chord
    :config
    (progn
      (key-chord-define-global "bn" 'buffer-flip-forward)
      (key-chord-define-global "bp" 'buffer-flip-backward)
      (key-chord-define-global "bf" 'buffer-flip)
      (key-chord-define-global "bo" 'buffer-flip-other-window)
      (key-chord-define-global "ba" 'buffer-flip-abort)
      (key-chord-define-global "jk" 'evil-normal-state)
      (key-chord-define-global "jb" 'ibuffer)
      (key-chord-define-global "g]"  #'xref-find-definitions)
      (key-chord-define-global "gj"  #'xref-find-references)
      (key-chord-define-global "gb"  #'xref-pop-marker-stack)
      (key-chord-define-global "j0" 'delete-window)
      (key-chord-define-global "j1" 'delete-other-windows)
      (key-chord-define-global "jz" 'magit-dispatch-popup)
      (key-chord-define-global "kb" 'gh/kill-current-buffer)
      (key-chord-mode 1)))

  (require 'auto-save)
  (auto-save-enable)
  (setq auto-save-silent t)
  (setq auto-save-delete-trailing-whitespace nil)

  (use-package all-the-icons :if (display-graphic-p))

  (require 'watch-other-window)

  (use-package color-rg
    ;:straight (:host github :repo "manateelazycat/color-rg")
    :load-path (lambda () (expand-file-name "vendor/color-rg/" user-emacs-directory))
    :commands (color-rg-search-input color-rg-search-project color-rg-search-symbol-in-project)
    :if (executable-find "rg")
    :bind ("C-M-s" . color-rg-search-input)
    )

  (require 'thing-edit)

  (use-package youdao-dictionary
    :commands youdao-dictionary-play-voice-of-current-word
    :init
    (setq url-automatic-caching t
	  youdao-dictionary-use-chinese-word-segmentation t) ; ä¸­æ–‡åˆ†è¯

    (defun my-youdao-search-at-point ()
      "Search word at point and display result with `posframe', `pos-tip', or buffer."
      (interactive)
      (if (display-graphic-p)
	  (youdao-dictionary-search-at-point-posframe)
	(youdao-dictionary-search-at-point))))

#+END_SRC
* Company
#+BEGIN_SRC emacs-lisp :tangle yes
; auto-completion and code snippets
(use-package yasnippet
  :ensure
  :config
  (yas-reload-all)
  (add-hook 'prog-mode-hook 'yas-minor-mode)
  (add-hook 'text-mode-hook 'yas-minor-mode))

(use-package company
  :ensure
  :bind
  (:map company-active-map
              ("C-n". company-select-next)
              ("C-p". company-select-previous)
              ("M-<". company-select-first)
              ("M->". company-select-last))
  (:map company-mode-map
        ("<tab>". tab-indent-or-complete)
        ("TAB". tab-indent-or-complete)))

(defun company-yasnippet-or-completion ()
  (interactive)
  (or (do-yas-expand)
      (company-complete-common)))

(defun check-expansion ()
  (save-excursion
    (if (looking-at "\\_>") t
      (backward-char 1)
      (if (looking-at "\\.") t
        (backward-char 1)
        (if (looking-at "::") t nil)))))

(defun do-yas-expand ()
  (let ((yas/fallback-behavior 'return-nil))
    (yas/expand)))

(defun tab-indent-or-complete ()
  (interactive)
  (if (minibufferp)
      (minibuffer-complete)
    (if (or (not yas/minor-mode)
            (null (do-yas-expand)))
        (if (check-expansion)
            (company-complete-common)
          (indent-for-tab-command)))))

#+END_SRC
* Dired
#+BEGIN_SRC emacs-lisp :tangle yes
  ;https://www.emacswiki.org/emacs/download/dired+.el
  (use-package dired
  :ensure nil
  :hook (dired-after-readin . dired-directory-sort)
  :config
  (require 'dired-x)

  (setq dired-dwim-target t
        ;; Humanize file size
        dired-listing-switches "-alh")
  ;; Sort directories ahead of files
  (defun dired-directory-sort ()
    "Dired sort hook to list directories first."
    (save-excursion
      (let (buffer-read-only)
        (forward-line 2) ;; beyond dir. header
        (sort-regexp-fields t "^.*$" "[ ]*." (point) (point-max))))
    (and (featurep 'xemacs)
         (fboundp 'dired-insert-set-properties)
         (dired-insert-set-properties (point-min) (point-max)))
    (set-buffer-modified-p nil)))

#+END_SRC

* UI
#+BEGIN_SRC emacs-lisp :tangle yes
  (use-package modus-themes
    ;:pin melpa
    :load-path "~/.emacs.d/vendor/modus-themes"
    ;:ensure t
    :init
    (setq modus-themes-org-blocks 'gray-background
	modus-themes-fringes 'subtle
	modus-themes-italic-constructs t
	modus-themes-bold-constructs t
	modus-themes-syntax '(alt-syntax)
	modus-themes-hl-line '(intense)
	modus-themes-paren-match '(intense)
	modus-themes-mode-line '(moody borderless))
    (setq modus-themes-headings
	  (quote ((1 . (overline variable-pitch 1.4))
		  (2 . (overline variable-pitch 1.25))
		  (3 . (overline 1.1))
		  (t . (monochrome))))))

  (require 'lazycat-theme)
  (setq-default mode-line-format (remove 'mode-line-buffer-identification mode-line-format))
  ;(load-theme 'modus-vivendi)
  ;(load-theme 'modus-operandi)
  (lazycat-theme-load-dark)

  (require 'awesome-tray)
  (use-package awesome-tray
    :load-path "~/.emacs.d/vendor/awesome-tray"
    :init
    (defface awesome-tray-module-rime-face
      '((((background light))
	 :foreground "#008080" :bold t)
	(t
	 :foreground "#00ced1" :bold t))
      "Rime ã„“ state face."
      :group 'awesome-tray)
    (defvar awesome-tray-rime-status-last-time 0)
    (defvar awesome-tray-rime-status-cache "")
    (defun awesome-tray-module-rime-info () (rime-lighter))
    (add-to-list 'awesome-tray-module-alist
		 '("rime" . (awesome-tray-module-rime-info awesome-tray-module-rime-face)))

    (awesome-tray-mode 1)
    :custom
    ;(awesome-tray-active-modules '("location" "belong" "file-path" "mode-name" "last-command" "battery" "date"))
    ;(awesome-tray-active-modules '("awesome-tab" "mode-name" "file-path" "buffer-name" "git" "rime" "location" "battery" "date"))
    (awesome-tray-active-modules '("location" "git" "file-path" "mode-name" "last-command" "battery" "date"))
    :config
    (add-hook 'circadian-after-load-theme-hook
	      #'(lambda (_)
		  (awesome-tray-mode 1))))

  (require 'awesome-tab)
  (require 'all-the-icons)
  (awesome-tab-mode t)
#+END_SRC

* Performance
#+BEGIN_SRC emacs-lisp :tangle yes
;; -------------------------------------------------------------
;; Performance
;; Disable garbage collection when entering commands.
(defun max-gc-limit ()
  (setq gc-cons-threshold most-positive-fixnum))

(defun reset-gc-limit ()
  (setq gc-cons-threshold 800000))

(add-hook 'minibuffer-setup-hook #'max-gc-limit)
(add-hook 'minibuffer-exit-hook #'reset-gc-limit)

;; Improve the performance of rendering long lines.
(setq-default bidi-display-reordering nil)
;;; Track Emacs commands frequency
(use-package keyfreq
  :ensure t
  :config (keyfreq-mode 1) (keyfreq-autosave-mode 1))

#+END_SRC
* Magit
#+BEGIN_SRC emacs-lisp :tangle yes

  ;; Magit is an Emacs interface to Git.
  (use-package magit
    :bind ("C-M-;" . magit-status)
    :commands (magit-status magit-get-current-branch)
    :config
    (magit-auto-revert-mode t)
    (magit-save-repository-buffers t)   
    (defun magit-display-buffer-same-window (buffer)
      "Display BUFFER in the selected window like God intended."
      (display-buffer buffer '(display-buffer-same-window)))
    (setq magit-display-buffer-function 'magit-display-buffer-same-window))

  (defun my/magit-display-buffer (buffer)
    (if (and git-commit-mode
	     (with-current-buffer buffer
	       (derived-mode-p 'magit-diff-mode)))
	(display-buffer buffer '((display-buffer-pop-up-window
				  display-buffer-use-some-window
				  display-buffer-below-selected)
				 (inhibit-same-window . t)))
      (magit-display-buffer-traditional buffer)))

  (setq magit-display-buffer-function #'my/magit-display-buffer)

  (use-package git-messenger
    :bind ("C-x G" . git-messenger:popup-message)
    :config (setq git-messenger:show-detail t git-messenger:use-magit-popup t))
  (use-package blamer
    :ensure t
    :defer 20
    :custom
    (blamer-idle-time 0.3)
    (blamer-min-offset 70)
    :custom-face
    (blamer-face ((t :foreground "#7a88cf"
		     :background nil
		     :height 140
		     :italic t))))

  (use-package git-gutter
    :diminish
    :ensure t
    :custom
    (git-gutter:modified-sign "~")
    (git-gutter:added-sign    "+")
    (git-gutter:deleted-sign  "-")
    :custom-face
    (git-gutter:modified ((t (:background "#f1fa8c"))))
    (git-gutter:added    ((t (:background "#50fa7b"))))
    (git-gutter:deleted  ((t (:background "#ff79c6"))))
    :config
    (global-git-gutter-mode +1))
#+END_SRC
* Evil-Mode
  #+BEGIN_SRC emacs-lisp :tangle yes
    ;;; C-y => paste the things to minibuffer, then use consel-rg
    (defun x/config-evil-leader ()
      "Configure evil leader mode."
      (evil-leader/set-leader ",")
      (evil-leader/set-key
	","  'avy-goto-char-2
	":"  'eval-expression

	"/"  'counsel-rg

	"A"  'align-regexp

	;"bb" 'ivy-switch-buffer
	"bb" 'switch-to-buffer
	"br" 'counsel-recentf
	"b[" 'previous-buffer
	"b]" 'next-buffer
	"bs" 'basic-save-buffer
	"bS" 'evil-write-all

	"cc" 'comment-dwim

	"db" 'kill-this-buffer
	"D"  'kill-buffer-and-window
	"do" 'delete-other-windows
	"dt" 'delete-trailing-whitespace

	"es" 'ivy-erlang-complete-find-spec
	"ef" 'ivy-erlang-complete-find-file
	"eh" 'ivy-erlang-complete-show-doc-at-point
	"ep" 'ivy-erlang-complete-set-project-root
	"ea" 'ivy-erlang-complete-autosetup-project-root
	"ek" 'get-erl-man
	"es" 'eshell-here
	"ec" 'eshell/clear
	"ed" 'eshell/close

	"ff" 'find-file-other-frame
	"fp" 'format-function-parameters
	"fd" 'dired-jump
	"fn" 'find-name-dired
	"fe" '(lambda () (interactive) (find-file (expand-file-name "config.org" user-emacs-directory)))
	"fr" '(lambda () (interactive) (load-file (expand-file-name "init.el" user-emacs-directory)))
	"fx" '(lambda () (interactive) (find-file (expand-file-name "~/.exports")))
	"fh" '(lambda () (interactive) (find-file (expand-file-name "~/")))

	"gs" 'magit-status
	"gb" 'magit-branch-checkout
	"gp" 'magit-pull
	"gB" 'global-blamer-mode
	"G"  'aborn/simple-git-commit-push

	"oy" 'my-youdao-search-at-point
	"oY" 'youdao-dictionary-search-from-input
	"of" 'other-frame
	"ow" 'other-window

	"pf" 'counsel-projectile-find-file
	"pp" 'counsel-projectile-switch-project
	"pb" 'counsel-projectile-switch-to-buffer
	"pk" 'projectile-kill-buffers
	"pr" 'projectile-recentf
	"ps" 'proxy-socks-toggle
	"ph" 'proxy-http-toggle

	"rb" 'generate-scratch-buffer
	"rv" 'rename-local-var

	"si" 'color-rg-search-input
	"ss" 'color-rg-search-symbol-in-project
	"sp" 'color-rg-search-project
	"sl" 'counsel-projectile-rg
	"sa" 'x/save-all
	"su" 'sudo
	"sc" 'my-org-screenshot 

	"tl" 'toggle-truncate-lines
	"tj" 'awesome-tab-backward-tab
	"tk" 'awesome-tab-forward-tab
	"th" 'awesome-tab-backward-group
	"tl" 'awesome-tab-forward-group
	"tg" 'awesome-tab-counsel-switch-group

	"vd" '(lambda () (interactive) (find-file "./Dockerfile"))
	"vc" '(lambda () (interactive) (find-file "./docker-compose.yml"))
	)

      (defun magit-blame-toggle ()
	"Toggle magit-blame-mode on and off interactively."
	(interactive)
	(if (and (boundp 'magit-blame-mode) magit-blame-mode)
	    (magit-blame-quit)
	  (call-interactively 'magit-blame)))
      )

    (use-package evil
      :ensure t
      :init
      (progn

	;; before evil-mode
	(setq evil-want-C-i-jump nil)
	(setq evil-want-C-u-scroll t)
	(setq evil-want-C-i-jump nil)

	(evil-mode t)

	(setq evil-want-fine-undo t)
	(setq evil-move-cursor-back nil)
	(setq evil-esc-delay 0)
	)
      :config
      (progn
	(use-package evil-visualstar
	  :bind (:map evil-visual-state-map
		      ("*" . evil-visualstar/begin-search-forward)
		      ("#" . evil-visualstar/begin-search-backward)))
	(use-package evil-leader
	  :init
	  (progn
	    (global-evil-leader-mode)
	    (setq evil-leader/in-all-states 1)
	    (x/config-evil-leader)))
	(use-package evil-surround
	  :ensure t
	  :config
	  (progn
	    (global-evil-surround-mode)))
	(use-package evil-escape
	  :ensure t
	  :config
	  (progn
	    (evil-escape-mode)
	    (setq-default evil-escape-key-sequence "tn")))))
  #+END_SRC
* Org-Mode
  #+BEGIN_SRC emacs-lisp :tangle yes
  ;; --------------------------------------------------------------
  ;; org -> latex -> pdf
  ;; --------------------------------------------------------------
  ;; latex supporting deps
  ;; https://orgmode.org/worg/org-dependencies.html
  ;; brew cask install basictex --verbose # verbose flag so I can see what is happening.
  ;; which pdflatex
  ;; export PATH=$PATH:/Library/TeX/texbin
  ;; pip install pygments
  ;; sudo tlmgr install minted
  ;; sudo tlmgr update --self --all
  ;; sudo tlmgr install ctex environ trimspaces zhnumber cjk
  ;; --------------------------------------------------------------
#+END_SRC
#+BEGIN_SRC emacs-lisp :tangle yes
  ; å‚è€ƒ: https://a358003542.github.io/articles/emacs-orgmode-learning-notes.html
  ; å‚è€ƒ: https://emacs-china.org/t/spacemacs-org-mode-pdf/1577
  (use-package org-download
    :ensure t
    :after org
    ;; There is something wrong with `hook`, so redefine it with my own :hook
    :init (add-hook 'org-mode-hook (lambda () (require 'org-download)))
    :config
    (setq-default org-download-image-dir "../images")
    (put 'org-download-image-dir 'safe-local-variable (lambda (_) t)))

  (use-package toc-org
    :after org
    :ensure t
    :hook
    (org-mode . toc-org-enable))

  (use-package org-superstar
	  :if (and (display-graphic-p) (char-displayable-p ?â—‰))
	  :hook (org-mode . org-superstar-mode)
	  :init (setq org-superstar-headline-bullets-list '("â—‰""â—‹""â—ˆ""â—‡""â•")))

  (use-package valign
    :defer t
    :ensure t
    :hook ((org-mode . valign-mode))
    :custom ((valign-fancy-bar t)))

  (use-package plantuml-mode
    :ensure t
    :config
    (add-to-list 'auto-mode-alist '("\\.plantuml\\'" . plantuml-mode))
    (setq plantuml-default-exec-mode 'jar)
    (setq plantuml-options "-charset UTF-8")
    (setq plantuml-jar-path plantuml-path))
  (setq org-plantuml-jar-path plantuml-path)
  (setq plantuml-default-exec-mode 'jar)
  (use-package plantuml-mode :magic ("@startuml" . plantuml-mode))
  (defun recompile-plantuml () (add-hook 'after-save-hook (lambda () (call-process "plantuml" nil nil nil (buffer-name)))))
  (add-hook 'org-babel-after-execute-hook (lambda () (when org-inline-image-overlays (org-redisplay-inline-images))))

  ;; latex è®¾ç½®
  (require 'ox-latex)

  ;; Babel
  (setq org-confirm-babel-evaluate nil
	org-src-fontify-natively t
	org-src-tab-acts-natively t)

  ;; Display
  (setq org-log-done 'time)
  (setq org-hide-leading-stars t)
  (setq org-startup-folded t)                   ; t, 'overview, 'content, 'showall.
  (setq org-pretty-entities nil)                ; ä¸‹åˆ’çº¿ä¸è½¬ä¸‹æ ‡
  (setq org-export-babel-evaluate t)
  (setq org-export-with-sub-superscripts nil)   ; ä¸‹åˆ’çº¿ä¸è½¬ä¸‹æ ‡
  (setq org-export-headline-levels 5)           ; 5çº§ç»“æ„
  (setq org-highlight-latex-and-related '(latex)) ; é«˜äº®latexä»£ç 
  (setq org-file-apps '(("pdf" . "open -a Skim %s")))

  ;; è¡¨æ ¼
  ; é•¿è¡¨æ ¼  longtableç¯å¢ƒï¼š   #+ATTR_LATEX: :environment longtable :align x{0.2\linewidth}x{0.2\linewidth}
  ; æ™®é€šè¡¨æ ¼tabularç¯å¢ƒï¼š #+ATTR_LATEX: :align p{0.18\linewidth}|p{0.72\linewidth}
  (setq org-latex-tables-booktabs t)            ; å¯ç”¨booktabså®åŒ…æ¨¡å¼, é¢å¤–æ”¯æŒæ’å…¥ä¸€äº›å±æ€§è®¾ç½®

  ;; å›¾ç‰‡
  ;; always resize inline images to 300 pixels, or use scale 0.8  in src plantuml
  (setq org-image-actual-width 200) 
  ;; if there is a #+ATTR_*: :width 200, resize to 200, otherwise resize to 400
					  ;(setq org-image-actual-width '(400)) 
  ;; if there is a #+ATTR_*: :width 200, resize to 200, otherwise donâ€™t resize
					  ;(setq org-image-actual-width nil) 
  ;; Never resize and use original width (the default)
					  ;(setq org-image-actual-width t) 
  (setq org-latex-image-default-option "keepaspectratio,max width=0.95\\linewidth")
  ;(setq org-latex-image-default-width "")
  (setq org-latex-default-figure-position "H")
#+END_SRC
** init-org-mode
#+BEGIN_SRC emacs-lisp :tangle yes
  ;; from  https://github.com/zhcosin/dotemacs/blob/master/lisp/init-orgmode.el
  (add-hook 'org-mode-hook 
	    (lambda () (setq truncate-lines nil))) 

  ;; å¼€å¯Org-modeæ–‡æœ¬å†…è¯­æ³•é«˜äº®
  ;(require 'org)
  ;(require 'ox-latex)
  ;(setq org-src-fontify-natively t)

  ;; åœ¨ org å…è®¸æ–‡ä»¶ä¸­æ‰§è¡Œä»£ç å—
  (use-package ob-http)
  (require 'ob-erlang)
  (require 'ob-go)
  (org-babel-do-load-languages
   'org-babel-load-languages
   '((emacs-lisp . t)
     (C . t)
     (http . t)
     (awk . t)
     (R . t)
     (org . t)
     (erlang . t)
     (js . t)
     (sql . t)
     (go . t)
     (python . t)
     (shell . t)
     (latex . t)
     (plantuml . t)))

  ;; è®¾ç½® org å¯¼å‡ºæ–‡æœ¬æ–‡ä»¶æ—¶çš„å•è¡Œæ–‡æœ¬æœ€å¤§å®½åº¦.
  (setq org-ascii-text-width 1000)

  ;; è®¾ç½® org å¯¼å‡ºä¸º html æ—¶å…¬å¼çš„ mathjax å¤„ç†å‚æ•°
  (setq org-html-mathjax-options
	'((path "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML")
	  (scale "100")
	  (align "center")
	  (indent "2em")
	  (mathml nil)))

  (setq org-html-mathjax-template
	"<script type=\"text/javascript\" src=\"%PATH\"></script>")


  ;; for export latex
  (add-to-list 'org-latex-classes
	       '("ctexart"
		 "\\documentclass[UTF8,a4paper]{ctexart}"
		 ;;"\\documentclass[fontset=none,UTF8,a4paper,zihao=-4]{ctexart}"
		 ("\\section{%s}" . "\\section*{%s}")
		 ("\\subsection{%s}" . "\\subsection*{%s}")
		 ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
		 ("\\paragraph{%s}" . "\\paragraph*{%s}")
		 ("\\subparagraph{%s}" . "\\subparagraph*{%s}")
		 )
	       )


  (add-to-list 'org-latex-classes
	       '("ctexrep"
		 "\\documentclass[UTF8,a4paper]{ctexrep}"
		 ("\\part{%s}" . "\\part*{%s}")
		 ("\\chapter{%s}" . "\\chapter*{%s}")
		 ("\\section{%s}" . "\\section*{%s}")
		 ("\\subsection{%s}" . "\\subsection*{%s}")
		 ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
		 )
	       )

  (add-to-list 'org-latex-classes
	       '("ctexbook"
		 "\\documentclass[UTF8,a4paper]{ctexbook}"
		 ;;("\\part{%s}" . "\\part*{%s}")
		 ("\\chapter{%s}" . "\\chapter*{%s}")
		 ("\\section{%s}" . "\\section*{%s}")
		 ("\\subsection{%s}" . "\\subsection*{%s}")
		 ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
		 )
	       )

  (add-to-list 'org-latex-classes
	       '("beamer"
		 "\\documentclass{beamer}
		   \\usepackage[fontset=none,UTF8,a4paper,zihao=-4]{ctex}"
		 org-beamer-sectioning)
	       )


  (setq org-latex-default-class "ctexart")
  (setq org-latex-compiler "xelatex")
  (setq org-latex-pdf-process
  '("xelatex -shell-escape -interaction nonstopmode -output-directory %o %f"
  "xelatex -shell-escape -interaction nonstopmode -output-directory %o %f"
  "xelatex -shell-escape -interaction nonstopmode -output-directory %o %f"
  "rm -fr %b.out %b.log %b.tex %b.brf %b.bbl"
   ))

  ;(setq org-latex-pdf-process
  ;  '("xelatex -interaction nonstopmode %f"
  ;    "bibtex %b"
  ;    "xelatex -interaction nonstopmode %f"
  ;    "xelatex -interaction nonstopmode %f"
  ;    "rm -fr %b.out %b.log %b.tex %b.brf %b.bbl"
  ;    ))
  ;(setq org-latex-pdf-process
  ;  '("xelatex -interaction nonstopmode -output-directory %o %f"
  ;    "xelatex -interaction nonstopmode -output-directory %o %f"
  ;    "xelatex -interaction nonstopmode -output-directory %o %f"))

  ;; for math.
  (defun zhcosin/insert-inline-formulas()
    (interactive)
    (insert "\\(  \\)")
    (backward-char 3))

  (define-key org-mode-map (kbd "M-$") 'zhcosin/insert-inline-formulas)
#+END_SRC
** init-auctex

#+BEGIN_SRC emacs-lisp :tangle yes
  (use-package auctex :defer t :ensure t)

  (load "auctex.el" nil t t)
  ;(load "preview-latex.el" nil t t)
  (if (string-equal system-type "windows-nt")
          (require 'tex-mik))


  ;; Ask which tex file is master instead of always assume current file is master file.
  (setq-default TeX-master nil) ; Query for master file.

  (mapc (lambda (mode)
        (add-hook 'LaTeX-mode-hook mode))
        (list 'LaTeX-math-mode
              'turn-on-reftex
              'linum-mode))

  (add-hook 'LaTeX-mode-hook
            (lambda ()
              (setq TeX-auto-untabify t     ; remove all tabs before saving
                    TeX-engine 'xetex       ; use xelatex default
                    TeX-show-compilation t) ; display compilation windows
              (TeX-global-PDF-mode t)       ; PDF mode enable, not plain
              (setq TeX-save-query nil)
              (imenu-add-menubar-index)
                (define-key LaTeX-mode-map (kbd "TAB") 'TeX-complete-symbol)))
#+END_SRC

** init-cdlatex

#+BEGIN_SRC emacs-lisp :tangle yes
  (use-package cdlatex
    :ensure t
    :config
    (add-hook 'org-mode-hook 'turn-on-org-cdlatex)
    (add-hook 'LaTeX-mode-hook 'turn-on-cdlatex))
#+END_SRC

** init-org2pdf

#+BEGIN_SRC emacs-lisp :tangle yes
  ;; org-latex-packages-alist ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯è¦åŠ è½½å®åŒ…çš„é€‰é¡¹ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯è¦åŠ è½½å®åŒ…çš„åå­—ï¼Œç¬¬ä¸‰ä¸ªé€‰é¡¹è®¾ç½®ä¸ºtæˆ–è€…nilï¼Œå³è¦åŠ è½½æˆ–è€…ä¸åŠ è½½ã€‚
  ;;org-mode export to latex, refer: https://emacs-china.org/t/spacemacs-org-mode-pdf/1577
    (require 'ox-latex)
    (setq org-export-latex-listings t)
    ;;org-mode source code setup in exporting to latex
    (add-to-list 'org-latex-listings '("" "listings"))
    (add-to-list 'org-latex-listings '("" "color"))

    (add-to-list 'org-latex-packages-alist
		 '("" "xcolor" t))
    (add-to-list 'org-latex-packages-alist
		 '("" "listings" t))
    (add-to-list 'org-latex-packages-alist
		 '("" "fontspec" t))
    (add-to-list 'org-latex-packages-alist
		 '("" "indentfirst" t))
    (add-to-list 'org-latex-packages-alist
		 '("" "xunicode" t))
    (add-to-list 'org-latex-packages-alist
		 '("" "geometry"))
    (add-to-list 'org-latex-packages-alist
		 '("" "float"))
    (add-to-list 'org-latex-packages-alist
		 '("" "longtable"))
    (add-to-list 'org-latex-packages-alist
		 '("" "tikz"))
    (add-to-list 'org-latex-packages-alist
		 '("" "fancyhdr"))
    (add-to-list 'org-latex-packages-alist
		 '("" "textcomp"))
    (add-to-list 'org-latex-packages-alist
		 '("" "amsmath"))
    (add-to-list 'org-latex-packages-alist
		 '("" "amsthm"))
    (add-to-list 'org-latex-packages-alist
		 '("" "tabularx" t))
    (add-to-list 'org-latex-packages-alist
		 '("" "booktabs" t))
    (add-to-list 'org-latex-packages-alist
		 '("" "grffile" t))
    (add-to-list 'org-latex-packages-alist
		 '("" "wrapfig" t))
    (add-to-list 'org-latex-packages-alist
		 '("normalem" "ulem" t))
    (add-to-list 'org-latex-packages-alist
		 '("" "amssymb" t))
    (add-to-list 'org-latex-packages-alist
		 '("" "capt-of" t))
    (add-to-list 'org-latex-packages-alist
		 '("figuresright" "rotating" t))
    (add-to-list 'org-latex-packages-alist
		 '("Lenny" "fncychap" t))

    (add-to-list 'org-latex-classes
		 '("zhcosin-org-book"
		   "\\documentclass{ctexbook}
  \\usepackage{titlesec}
  \\usepackage{hyperref}
  [NO-DEFAULT-PACKAGES]
  [PACKAGES]
  \\newtheorem{theorem}{å®šç†}[section]
  %\\setCJKmainfont{WenQuanYi Micro Hei} % è®¾ç½®ç¼ºçœä¸­æ–‡å­—ä½“
  %\\setCJKsansfont{WenQuanYi Micro Hei}
  %\\setCJKmonofont{WenQuanYi Micro Hei Mono}
  %\\setmainfont{DejaVu Sans} % è‹±æ–‡è¡¬çº¿å­—ä½“
  %\\setsansfont{DejaVu Serif} % è‹±æ–‡æ— è¡¬çº¿å­—ä½“
  %\\setmonofont{DejaVu Sans Mono}
  %\\setmainfont{WenQuanYi Micro Hei} % è®¾ç½®ç¼ºçœä¸­æ–‡å­—ä½“
  %\\setsansfont{WenQuanYi Micro Hei}
  %\\setmonofont{WenQuanYi Micro Hei Mono}
  %å¦‚æœæ²¡æœ‰å®ƒï¼Œä¼šæœ‰ä¸€äº› tex ç‰¹æ®Šå­—ç¬¦æ— æ³•æ­£å¸¸ä½¿ç”¨ï¼Œæ¯”å¦‚è¿å­—ç¬¦ã€‚
  \\defaultfontfeatures{Mapping=tex-text}
  % ä¸­æ–‡æ–­è¡Œ
  \\XeTeXlinebreaklocale \"zh\"
  \\XeTeXlinebreakskip = 0pt plus 1pt minus 0.1pt
  % ä»£ç è®¾ç½®
  \\lstset{numbers=left,
  numberstyle= \\tiny,
  keywordstyle= \\color{ blue!70},commentstyle=\\color{red!50!green!50!blue!50},
  frame=shadowbox,
  breaklines=true,
  rulesepcolor= \\color{ red!20!green!20!blue!20}
  }
  [EXTRA]
  "
		   ("\\chapter{%s}" . "\\chapter*{%s}")
		   ("\\section{%s}" . "\\section*{%s}")
		   ("\\subsection{%s}" . "\\subsection*{%s}")
		   ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
		   ("\\paragraph{%s}" . "\\paragraph*{%s}")
		   ("\\subparagraph{%s}" . "\\subparagraph*{%s}")))

    (add-to-list 'org-latex-classes
		 '("zhcosin-org-article"
		   "\\documentclass{ctexart}
  \\usepackage{titlesec}
  \\usepackage{hyperref}
  [NO-DEFAULT-PACKAGES]
  [PACKAGES]
  \\newtheorem{theorem}{å®šç†}[section]
  \\parindent 2em
  %\\setCJKmainfont{WenQuanYi Micro Hei} % è®¾ç½®ç¼ºçœä¸­æ–‡å­—ä½“
  %\\setCJKsansfont{WenQuanYi Micro Hei}
  %\\setCJKmonofont{WenQuanYi Micro Hei Mono}
  %\\setmainfont{DejaVu Sans} % è‹±æ–‡è¡¬çº¿å­—ä½“
  %\\setsansfont{DejaVu Serif} % è‹±æ–‡æ— è¡¬çº¿å­—ä½“
  %\\setmonofont{DejaVu Sans Mono}
  %\\setmainfont{WenQuanYi Micro Hei} % è®¾ç½®ç¼ºçœä¸­æ–‡å­—ä½“
  %\\setsansfont{WenQuanYi Micro Hei}
  %\\setmonofont{WenQuanYi Micro Hei Mono}
  %å¦‚æœæ²¡æœ‰å®ƒï¼Œä¼šæœ‰ä¸€äº› tex ç‰¹æ®Šå­—ç¬¦æ— æ³•æ­£å¸¸ä½¿ç”¨ï¼Œæ¯”å¦‚è¿å­—ç¬¦ã€‚
  \\defaultfontfeatures{Mapping=tex-text}
  % ä¸­æ–‡æ–­è¡Œ
  \\XeTeXlinebreaklocale \"zh\"
  \\XeTeXlinebreakskip = 0pt plus 1pt minus 0.1pt
  % ä»£ç è®¾ç½®
  \\lstset{numbers=left,
  numberstyle= \\tiny,
  keywordstyle= \\color{ blue!70},commentstyle=\\color{red!50!green!50!blue!50},
  frame=shadowbox,
  breaklines=true,
  rulesepcolor= \\color{ red!20!green!20!blue!20}
  }
  [EXTRA]
  "
		   ("\\section{%s}" . "\\section*{%s}")
		   ("\\subsection{%s}" . "\\subsection*{%s}")
		   ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
		   ("\\paragraph{%s}" . "\\paragraph*{%s}")
		   ("\\subparagraph{%s}" . "\\subparagraph*{%s}")))

    (add-to-list 'org-latex-classes
		 '("zhcosin-org-beamer"
		   "\\documentclass{beamer}
  \\usepackage[slantfont, boldfont]{xeCJK}
  % beamer set
  \\usepackage[none]{hyphenat}
  \\usepackage[abs]{overpic}
  [NO-DEFAULT-PACKAGES]
  [PACKAGES]
  \\newtheorem{theorem}{å®šç†}[section]
  \\setCJKmainfont{WenQuanYi Micro Hei} % è®¾ç½®ç¼ºçœä¸­æ–‡å­—ä½“
  \\setCJKsansfont{WenQuanYi Micro Hei}
  \\setCJKmonofont{WenQuanYi Micro Hei Mono}
  \\setmainfont{DejaVu Sans} % è‹±æ–‡è¡¬çº¿å­—ä½“
  \\setsansfont{DejaVu Serif} % è‹±æ–‡æ— è¡¬çº¿å­—ä½“
  \\setmonofont{DejaVu Sans Mono}
  %\\setmainfont{WenQuanYi Micro Hei} % è®¾ç½®ç¼ºçœä¸­æ–‡å­—ä½“
  %\\setsansfont{WenQuanYi Micro Hei}
  %\\setmonofont{WenQuanYi Micro Hei Mono}
  %å¦‚æœæ²¡æœ‰å®ƒï¼Œä¼šæœ‰ä¸€äº› tex ç‰¹æ®Šå­—ç¬¦æ— æ³•æ­£å¸¸ä½¿ç”¨ï¼Œæ¯”å¦‚è¿å­—ç¬¦ã€‚
  \\defaultfontfeatures{Mapping=tex-text}
  % ä¸­æ–‡æ–­è¡Œ
  \\XeTeXlinebreaklocale \"zh\"
  \\XeTeXlinebreakskip = 0pt plus 1pt minus 0.1pt
  % ä»£ç è®¾ç½®
  \\lstset{numbers=left,
  numberstyle= \\tiny,
  keywordstyle= \\color{ blue!70},commentstyle=\\color{red!50!green!50!blue!50},
  frame=shadowbox,
  breaklines=true,
  rulesepcolor= \\color{ red!20!green!20!blue!20}
  }
  [EXTRA]
  "
		   ("\\section{%s}" . "\\section*{%s}")
		   ("\\subsection{%s}" . "\\subsection*{%s}")
		   ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
		   ("\\paragraph{%s}" . "\\paragraph*{%s}")
		   ("\\subparagraph{%s}" . "\\subparagraph*{%s}")))

#+END_SRC

* Programming
#+BEGIN_SRC emacs-lisp :tangle yes

  ;;---------------------------------------------------------
  ;; lsp-bridge config
  ;;---------------------------------------------------------
    ;;; Require
  (require 'lsp-bridge)
  (require 'lsp-bridge-jdtls)

    ;;; Code:

  (global-lsp-bridge-mode)

  ;; èåˆ `lsp-bridge' `find-function' ä»¥åŠ `dumb-jump' çš„æ™ºèƒ½è·³è½¬
  (defun lsp-bridge-jump ()
    (interactive)
    (cond
     ((eq major-mode 'emacs-lisp-mode)
      (let ((symb (function-called-at-point)))
	(when symb
	  (find-function symb))))
     (lsp-bridge-mode
      (lsp-bridge-find-def))
     (t
      (require 'dumb-jump)
      (dumb-jump-go))))

  (defun lsp-bridge-jump-back ()
    (interactive)
    (cond
     (lsp-bridge-mode
      (lsp-bridge-find-def-return))
     (t
      (require 'dumb-jump)
      (dumb-jump-back))))

  (setq lsp-bridge-get-single-lang-server-by-project
	(lambda (project-path filepath)
	  (when (member (file-name-base project-path) '("deno-bridge" "deno-bridge-ts"))
	    "deno")))

  ;; æ‰“å¼€æ—¥å¿—ï¼Œå¼€å‘è€…æ‰éœ€è¦
  ;; (setq lsp-bridge-enable-log t)

  ;;---------------------------------------------------------
  ;; Golang
  ;;---------------------------------------------------------
  (use-package go-mode
    :functions (go-packages-gopkgs go-update-tools)
    :bind (:map go-mode-map
		("C-c R" . go-remove-unused-imports)
		("<f1>" . godoc-at-point))
    :config
    ;; Env vars
    (with-eval-after-load 'exec-path-from-shell
      (exec-path-from-shell-copy-envs '("GOPATH" "GO111MODULE" "GOPROXY")))

    ;; Install or update tools
    (defvar go--tools '("golang.org/x/tools/cmd/goimports"
			"github.com/go-delve/delve/cmd/dlv"
			"github.com/josharian/impl"
			"github.com/cweill/gotests/..."
			"github.com/fatih/gomodifytags"
			"github.com/davidrjenni/reftools/cmd/fillstruct")
      "All necessary go tools.")

    ;; Do not use the -u flag for gopls, as it will update the dependencies to incompatible versions
    ;; https://github.com/golang/tools/blob/master/gopls/doc/user.md#installation
    (defvar go--tools-no-update '("golang.org/x/tools/gopls@latest")
      "All necessary go tools without update the dependencies.")

    (defun go-update-tools ()
      "Install or update go tools."
      (interactive)
      (unless (executable-find "go")
	(user-error "Unable to find `go' in `exec-path'!"))

      (message "Installing go tools...")
      (let ((proc-name "go-tools")
	    (proc-buffer "*Go Tools*"))
	(dolist (pkg go--tools-no-update)
	  (set-process-sentinel
	   (start-process proc-name proc-buffer "go" "get" "-v" pkg)
	   (lambda (proc _)
	     (let ((status (process-exit-status proc)))
	       (if (= 0 status)
		   (message "Installed %s" pkg)
		 (message "Failed to install %s: %d" pkg status))))))

	(dolist (pkg go--tools)
	  (set-process-sentinel
	   (start-process proc-name proc-buffer "go" "get" "-u" "-v" pkg)
	   (lambda (proc _)
	     (let ((status (process-exit-status proc)))
	       (if (= 0 status)
		   (message "Installed %s" pkg)
		 (message "Failed to install %s: %d" pkg status))))))))

    ;; Try to install go tools if `gopls' is not found
    (unless (executable-find "gopls")
      (go-update-tools))

    ;; Misc
					  ;(use-package go-dlv)
    (use-package go-fill-struct)
    (use-package go-impl)

    ;; Install: See https://github.com/golangci/golangci-lint#install
    (use-package flycheck-golangci-lint
      :if (executable-find "golangci-lint")
      :after flycheck
      :defines flycheck-disabled-checkers
      :hook (go-mode . (lambda ()
			 "Enable golangci-lint."
			 (setq flycheck-disabled-checkers '(go-gofmt
							    go-golint
							    go-vet
							    go-build
							    go-test
							    go-errcheck))
			 (flycheck-golangci-lint-setup))))

    (use-package go-tag
      :bind (:map go-mode-map
		  ("C-c t t" . go-tag-add)
		  ("C-c t T" . go-tag-remove))
      :init (setq go-tag-args (list "-transform" "camelcase")))

    (use-package go-gen-test
      :bind (:map go-mode-map
		  ("C-c t g" . go-gen-test-dwim)))

    (use-package gotest
      :bind (:map go-mode-map
		  ("C-c t a" . go-test-current-project)
		  ("C-c t m" . go-test-current-file)
		  ("C-c t ." . go-test-current-test)
		  ("C-c t x" . go-run))))

  ;;---------------------------------------------------------
  ;; Erlang
  ;;---------------------------------------------------------
  ;;---------------------------------------------------------
  ;; wget http://erlang.org/download/otp_src_22.3.tar.gz
  ;; tar zxvf otp_src_22.3.tar.gz
  ;; cd otp_src_22.3
  ;; ./configure --with-ssl && make && make install
  ;;---------------------------------------------------------------
  (use-package erlang
    :mode (("\\.erl?$" . erlang-mode)
	   ("rebar\\.config$" . erlang-mode)
	   ("relx\\.config$" . erlang-mode)
	   ("sys\\.config\\.src$" . erlang-mode)
	   ("sys\\.config$" . erlang-mode)
	   ("\\.config\\.src?$" . erlang-mode)
	   ("\\.config\\.script?$" . erlang-mode)
	   ("\\.hrl?$" . erlang-mode)
	   ("\\.app?$" . erlang-mode)
	   ("\\.app.src?$" . erlang-mode)
	   ("\\Emakefile" . erlang-mode)))

  ;;---------------------------------------------------------
  ;; C/C++ Mode
  ;;---------------------------------------------------------
  (use-package cc-mode
    :ensure nil
    :bind (:map c-mode-base-map
		("C-c c" . compile))
    :hook (c-mode-common . (lambda () (c-set-style "stroustrup")))
    :init (setq-default c-basic-offset 4)
    :config
    (use-package modern-cpp-font-lock
      :diminish
      :init (modern-c++-font-lock-global-mode t)))

  ;;---------------------------------------------------------
  ;; Python Mode
  ;; Install: pip install pyflakes autopep8
  ;;---------------------------------------------------------
  (use-package python
    :ensure nil
    :hook (inferior-python-mode . (lambda ()
				    (process-query-on-exit-flag
				     (get-process "Python"))))
    :init
    ;; Disable readline based native completion
    (setq python-shell-completion-native-enable nil)
    :config
    ;; Default to Python 3. Prefer the versioned Python binaries since some
    ;; systems stupidly make the unversioned one point at Python 2.
    (when (and (executable-find "python3")
	       (string= python-shell-interpreter "python"))
      (setq python-shell-interpreter "python3"))

    ;; Env vars
    (with-eval-after-load 'exec-path-from-shell
      (exec-path-from-shell-copy-env "PYTHONPATH"))

    ;; Live Coding in Python
    (use-package live-py-mode))

  ;;---------------------------------------------------------
  ;; rust
  ;;---------------------------------------------------------

  (use-package rust-mode
    :config
    (setq rust-format-on-save t)
    )

  ;;---------------------------------------------------------
  ;; Other languages
  ;;---------------------------------------------------------
  (use-package sh-script :defer t :config (setq sh-basic-offset 4))
  (use-package lua-mode  :defer t :config (add-hook 'lua-mode-hook #'company-mode))
  (use-package yaml-mode :defer t :config (add-hook 'yaml-mode-hook #'flycheck-mode))
  (use-package flycheck-yamllint
    :defer t
    :init
    (progn (eval-after-load 'flycheck '(add-hook 'flycheck-mode-hook 'flycheck-yamllint-setup))))

  ;;---------------------------------------------------------
  ;; Dash
  ;;---------------------------------------------------------
  (use-package dash-at-point :ensure t)

#+END_SRC
* AutoInsert
  #+BEGIN_SRC emacs-lisp :tangle yes
    (load "autoinsert")
    (auto-insert-mode)
    (setq auto-insert t)
    (setq auto-insert-query t)
    (add-hook 'find-file-hooks 'auto-insert)
    (setq auto-insert-alist
	  (append '(
		    (("\\.go$" . "golang header")
		     nil
		     "//---------------------------------------------------------------------\n"
		     "// @Copyright (c) 2020-2021 GLD Enterprise, Inc. (https://glodon.com)\n"
		     "// @Author: robertzhouxh <robertzhouxh@gmail.com>\n"
		     "// @Date   Created: " (format-time-string "%Y-%m-%d %H:%M:%S")"\n"
		     "//----------------------------------------------------------------------\n"
		     _
		     ))
		  auto-insert-alist))
    (setq auto-insert-alist
	  (append '(
		    (("\\.erl$" . "erlang header")
		     nil
		     "%%%-------------------------------------------------------------------\n"
		     "%%% @Copyright (c) 2020-2021 GLD Enterprise, Inc. (https://glodon.com)\n"
		     "%%% @Author: robertzhouxh <robertzhouxh@gmail.com>\n"
		     "%%% @Date   Created: " (format-time-string "%Y-%m-%d %H:%M:%S")"\n"
		     "%%%-------------------------------------------------------------------\n"
		     _
		     ))
		  auto-insert-alist))
    (setq auto-insert-alist
	  (append '(
		    (("\\.org$" . "org header")
		     nil
		     "#+title: TODO\n"
		     "#+author: å‘¨å­¦æµ©\n"
		     "#+email: zhouxh-e@glodon.com\n"
		     "#+date:" (format-time-string "%Y-%m-%d %H:%M:%S")"\n"
		     "#+OPTIONS: ^:nil\n"
		     "#+OPTIONS: toc:nil\n"
		     "#+LATEX_CLASS: zhcosin-org-article\n"
		     "#+LATEX_HEADER: \\hypersetup{colorlinks=true,linkcolor=blue}\n"
		     "#+LATEX_HEADER: \\makeatletter \\def\\@maketitle{\\null \\begin{center} {\\vskip 5em \\Huge \\@title} \\vskip 30em {\\LARGE \\@author} \\vskip 3em {\\LARGE \\@date} \\end{center} \\newpage} \\makeatother\n\n"
		     "* ç›®å½• :TOC_2_org:"
		     _
		     ))
		  auto-insert-alist))

#+END_SRC
* Tramp
#+BEGIN_SRC emacs-lisp :tangle yes

;; Remote SSH
;; C-x C-f /remotehost:filename RET (or /method:user@remotehost:filename)
;; type C-x C-f /ssh:root@ssb.willschenk.com:/etc/host= it connects over ssh to the remote server and edits that file.
;; dired mode also works, so if you want to move around just C-x C-f and select the directory, then you can navigate around as you normally would.
;; C-x C-f /sudo::/etc/hosts
;; Another fun trick is to edit a file inside of a docker container. Is this what docker is used for? No,
;; but itâ€™s sometimes useful if you are debugging a docker file or whatever and need a tigher feedback loop.
(use-package tramp
  :config
  (setq tramp-default-method "ssh"
	tramp-auto-save-directory (expand-file-name "~/.emacs.d/auto-save-list")))
(use-package docker-tramp :after (tramp) :config)
(use-package kubernetes-tramp :after (tramp) :config)

;; Open files in Docker containers like so: /docker:drunk_bardeen:/etc/passwd
(push
 (cons
  "docker"
  '((tramp-login-program "docker")
    (tramp-login-args (("exec" "-it") ("%h") ("/bin/bash")))
    (tramp-remote-shell "/bin/sh")
    (tramp-remote-shell-args ("-i") ("-c"))))
 tramp-methods)

(defadvice tramp-completion-handle-file-name-all-completions
  (around dotemacs-completion-docker activate)
  "(tramp-completion-handle-file-name-all-completions \"\" \"/docker:\" returns
    a list of active Docker container names, followed by colons."
  (if (equal (ad-get-arg 1) "/docker:")
      (let* ((dockernames-raw (shell-command-to-string "docker ps | awk '$NF != \"NAMES\" { print $NF \":\" }'"))
             (dockernames (cl-remove-if-not
                           #'(lambda (dockerline) (string-match ":$" dockerline))
                           (split-string dockernames-raw "\n"))))
        (setq ad-return-value dockernames))
    ad-do-it))

; To try this out, we can spin up a quick server like this
; docker run --rm -p 6379:6379 --name redis_container redis
; And then look at files inside of it using
; C-x C-f /docker:redis_container:/

; Inside a docker container on a remote host
; We can also chain things together! Lets say that we have a docker container named ssb-pub running on a remote host ssb.willschenk.com, we can connect to it using:
; C-x C-f /ssh:root@ssb.willschenk.com|docker:ssb-pub:/

#+END_SRC
* Font
#+BEGIN_SRC emacs-lisp :tangle yes

  ;; stolen from https://github.com/cabins/.emacs.d/blob/dev/lisp/init-ui.el
  ;; adjust the fonts
  (require 'subr-x)

  (defun font-installed-p (font-name)
    "Check if font with FONT-NAME is available."
    (find-font (font-spec :name font-name)))

  (defun cabins/font-setup ()
    "Font setup."

    (interactive)
    (when (display-graphic-p)
      ;; Default font
      (cl-loop for font in '("Consolas" "Monaco" "Hack" "Source Code Pro" "Menlo" "DejaVu Sans Mono")
	       when (font-installed-p font)
	       return (set-face-attribute 'default nil :family font))

      ;; Unicode characters
      (cl-loop for font in '("Segoe UI Symbol" "Symbola" "Symbol")
	       when (font-installed-p font)
	       return (set-fontset-font t 'unicode font nil 'prepend))

      ;; Emoji
      (cl-loop for font in '("Noto Color Emoji" "Apple Color Emoji")
	       when (font-installed-p font)
	       return (set-fontset-font t 'emoji (font-spec :family font) nil 'prepend))

      ;; Chinese characters
      (cl-loop for font in '("FZLanTingHeiS-EL-GB" "PingFang SC" "Microsoft Yahei UI" "Microsoft Yahei" "STFangsong")
	       when (font-installed-p font)
	       return (progn
			;(setq face-font-rescale-alist `((,font . 1.2)))
			(set-fontset-font t '(#x4e00 . #x9fff) (font-spec :family font))))))

  (add-hook 'emacs-startup-hook 'cabins/font-setup)
  (when (daemonp) (add-hook 'after-make-frame-functions (lambda (frame) (with-selected-frame frame (cabins/font-setup)))))

  (set-face-attribute 'default nil :height 140)


#+END_SRC
* Rime
  #+BEGIN_SRC emacs-lisp :tangle yes
    (use-package posframe :ensure t)

    ;ä½¿ç”¨ toggle-input-method æ¥æ¿€æ´»ï¼Œé»˜è®¤å¿«æ·é”®ä¸º C-\

    (use-package rime
      :ensure t
      :custom
      (rime-librime-root (expand-file-name "librime/dist" user-emacs-directory))
      (default-input-method "rime")
      :config
      (setq rime-user-data-dir "~/Library/Rime/")
      (setq rime-show-candidate 'posframe)
      (setq rime-posframe-style 'vertical) ;horizontal,simple
      (setq rime-disable-predicates
	    '(rime-predicate-evil-mode-p
		  rime-predicate-after-alphabet-char-p
		  rime-predicate-prog-in-code-p))
      (setq rime-inline-ascii-trigger 'shift-l)
      (define-key rime-active-mode-map (kbd "M-j") 'rime-inline-ascii)
      (define-key rime-mode-map (kbd "C-`") 'rime-send-keybinding)
      (setq mode-line-mule-info '((:eval (rime-lighter))))
      (setq rime-posframe-properties
	    (list :background-color "#333333"
		  :foreground-color "#dcdccc"
		  ;;:font "WenQuanYi Micro Hei Mono-14"
		  :font "Sarasa Mono SC Nerd"
		  :internal-border-width 10))
      )
  #+END_SRC
* Platform
  #+BEGIN_SRC emacs-lisp :tangle yes

    (defun peng-use-mac-original-keyboard ()
      "è¿™æ ·ä½¿ç”¨è‹¹æœåŸç”Ÿçš„é”®ç›˜æ¯”è¾ƒç¬¦å’Œæˆ‘çš„ä¹ æƒ¯"
      (interactive)
      (setq mac-command-modifier 'control)
      (setq mac-right-command-modifier 'meta)
      (setq mac-right-option-modifier 'control)
      (setq mac-control-modifier 'control)
      (setq mac-right-control-modifier 'control)
      )

    (defun peng-use-filco-keyboard ()
      "è¿™æ ·ä½¿ç”¨`filco'é”®ç›˜æ—¶ç¬¦åˆæˆ‘çš„æŒ‰é”®ä¹ æƒ¯ã€‚"
      (interactive)
      (setq mac-command-modifier 'control)
      (setq mac-right-command-modifier 'control)
      (setq mac-right-option-modifier 'meta)
      (setq mac-control-modifier 'control)
      )


    (when (x/system-is-mac)
      (setq mac-command-modifier 'meta
	    mac-option-modifier 'none)
					    ;(peng-use-mac-original-keyboard)
					    ;(set-face-attribute 'default nil :height 140)

      (defun copy-from-osx ()
	(shell-command-to-string "pbpaste"))
      (defun paste-to-osx (text &optional push)
	(let ((process-connection-type nil))
	  (let ((proc (start-process "pbcopy" "*Messages*" "pbcopy")))
	    (process-send-string proc text)
	    (process-send-eof proc))))
      (setq interprogram-cut-function 'paste-to-osx)
      (setq interprogram-paste-function 'copy-from-osx)

      ;; Trash for safe
      (defun move-file-to-trash (file)
	"Use `trash' to move FILE to the system trash.
	When using Homebrew, install it using \"brew install trash\"."
	(call-process (executable-find "trash")
		      nil 0 nil
		      file))
      (setq trash-directory "~/.Trash/emacs")
      (setq delete-by-moving-to-trash t)
      (defun system-move-file-to-trash (file)
	"Use \"trash\" to move FILE to the system trash.
	  When using Homebrew, install it using \"brew install trash\"."
	(call-process (executable-find "trash")
		      nil 0 nil
		      file))
      (message "Wellcome To Mac OS X, Have A Nice Day!!!"))

    (when (x/system-is-linux)
      (defun yank-to-x-clipboard ()
	(interactive)
	(if (region-active-p)
	    (progn
	      (shell-command-on-region (region-beginning) (region-end) "xsel -i -b")
	      (message "Yanked region to clipboard!")
	      (deactivate-mark))
	  (message "No region active; can't yank to clipboard!"))))

  #+END_SRC
* Key-maps

  #+BEGIN_SRC emacs-lisp :tangle yes

    ;; {{ specify major mode uses Evil (vim) NORMAL state or EMACS original state.
    ;; You may delete this setup to use Evil NORMAL state always.
    (dolist (p '((minibuffer-inactive-mode . emacs)
		 (calendar-mode . emacs)
		 (special-mode . emacs)
		 (grep-mode . emacs)
		 (Info-mode . emacs)
		 (term-mode . emacs)
		 (sdcv-mode . emacs)
		 (anaconda-nav-mode . emacs)
		 (log-edit-mode . emacs)
		 (vc-log-edit-mode . emacs)
		 (magit-log-edit-mode . emacs)
		 (erc-mode . emacs)
		 (neotree-mode . emacs)
		 (w3m-mode . emacs)
		 (gud-mode . emacs)
		 (help-mode . emacs)
		 (eshell-mode . emacs)
		 (shell-mode . emacs)
		 (xref--xref-buffer-mode . emacs)
		 ;;(message-mode . emacs)
		 (color-rg-mode . emacs)
		 (fundamental-mode . normal)
		 (woman-mode . emacs)
		 (sr-mode . emacs)
		 (profiler-report-mode . emacs)
		 (dired-mode . normal)
		 (compilation-mode . emacs)
		 (speedbar-mode . emacs)
		 (ivy-occur-mode . emacs)
		 (ffip-file-mode . emacs)
		 (ivy-occur-grep-mode . normal)
		 (messages-buffer-mode . normal)
		 ))
      (evil-set-initial-state (car p) (cdr p)))


    ;; evil
    (define-key evil-normal-state-map           [escape] 'keyboard-quit)
    (define-key evil-visual-state-map           [escape] 'keyboard-quit)
    (define-key minibuffer-local-map            [escape] 'minibuffer-keyboard-quit)
    (define-key minibuffer-local-ns-map         [escape] 'minibuffer-keyboard-quit)
    (define-key minibuffer-local-completion-map [escape] 'minibuffer-keyboard-quit)
    (define-key minibuffer-local-must-match-map [escape] 'minibuffer-keyboard-quit)
    (define-key minibuffer-local-isearch-map    [escape] 'minibuffer-keyboard-quit)
    (define-key evil-normal-state-map "\C-a" 'evil-begin-of-line)
    (define-key evil-insert-state-map "\C-a" 'evil-begin-of-line)
    (define-key evil-visual-state-map "\C-a" 'evil-begin-of-line)
    (define-key evil-motion-state-map "\C-a" 'evil-begin-of-line)
    (define-key evil-normal-state-map "\C-e" 'evil-end-of-line)
    (define-key evil-insert-state-map "\C-e" 'evil-end-of-line)
    (define-key evil-visual-state-map "\C-e" 'evil-end-of-line)
    (define-key evil-motion-state-map "\C-e" 'evil-end-of-line)
    (define-key evil-normal-state-map "\C-f" 'evil-forward-char)
    (define-key evil-insert-state-map "\C-f" 'evil-forward-char)
    (define-key evil-insert-state-map "\C-f" 'evil-forward-char)
    (define-key evil-normal-state-map "\C-b" 'evil-backward-char)
    (define-key evil-insert-state-map "\C-b" 'evil-backward-char)
    (define-key evil-visual-state-map "\C-b" 'evil-backward-char)
    (define-key evil-normal-state-map "\C-n" 'evil-next-line)
    (define-key evil-insert-state-map "\C-n" 'evil-next-line)
    (define-key evil-visual-state-map "\C-n" 'evil-next-line)
    (define-key evil-normal-state-map "\C-p" 'evil-previous-line)
    (define-key evil-insert-state-map "\C-p" 'evil-previous-line)
    (define-key evil-visual-state-map "\C-p" 'evil-previous-line)
    (define-key evil-normal-state-map "\C-w" 'evil-delete)
    (define-key evil-insert-state-map "\C-w" 'evil-delete)
    (define-key evil-visual-state-map "\C-w" 'evil-delete)
    (define-key evil-normal-state-map "\C-y" 'yank)
    (define-key evil-insert-state-map "\C-y" 'yank)
    (define-key evil-visual-state-map "\C-y" 'yank)
    (define-key evil-normal-state-map "\C-k" 'kill-line)
    (define-key evil-insert-state-map "\C-k" 'kill-line)
    (define-key evil-visual-state-map "\C-k" 'kill-line)
    (defun evil-escape-or-quit (&optional prompt)
      (interactive)
      (cond
       ((or (evil-normal-state-p) (evil-insert-state-p) (evil-visual-state-p)
	    (evil-replace-state-p) (evil-visual-state-p)) [escape])
       (t (kbd "C-g"))))
    (define-key key-translation-map     (kbd "C-q") #'evil-escape-or-quit)
    (define-key evil-operator-state-map (kbd "C-q") #'evil-escape-or-quit)
    (define-key evil-normal-state-map (kbd "j") 'evil-next-visual-line)
    (define-key evil-normal-state-map (kbd "k") 'evil-previous-visual-line)


    (define-key dired-mode-map           (kbd "e")   'wdired-change-to-wdired-mode)
    (define-key evil-normal-state-map    (kbd "/")   'swiper)
    (define-key evil-normal-state-map    (kbd "_")   'projectile-dired)
    (define-key evil-normal-state-map    (kbd "-")   'dired-jump)
    (define-key evil-normal-state-map    (kbd "C-s") 'save-buffer)
    (define-key company-active-map       (kbd "C-n") 'company-select-next)
    (define-key company-active-map       (kbd "C-p") 'company-select-previous)
    (define-key evil-insert-state-map    (kbd "C-g") 'evil-normal-state)
    (define-key rust-mode-map            (kbd "M-1") 'rust-run)

    ;; company
    (with-eval-after-load 'company
      (define-key company-active-map (kbd "<return>") nil)
      (define-key company-active-map (kbd "<tab>") nil)
      (define-key company-active-map (kbd "RET") nil)
      (define-key company-active-map (kbd "M-n") nil)
      (define-key company-active-map (kbd "M-p") nil)
      (define-key company-active-map (kbd "C-m") nil)

      (define-key company-active-map (kbd "TAB") 'company-complete-selection)
      (define-key company-active-map (kbd "M-h") 'company-complete-selection)
      (define-key company-active-map (kbd "M-H") 'company-complete-common)
      (define-key company-active-map (kbd "M-w") 'company-show-location)
      (define-key company-active-map (kbd "M-s") 'company-search-candidates)
      (define-key company-active-map (kbd "M-S") 'company-filter-candidates)
      (define-key company-active-map (kbd "M-n") 'company-select-next)
      (define-key company-active-map (kbd "M-p") 'company-select-previous)
      (define-key company-active-map (kbd "M-i") 'yas-expand)
      )

    ;; C-h b æ‰¾åˆ°å¿«æ·é”®bind function---remap
    (with-eval-after-load 'evil
      (define-key evil-motion-state-map (kbd "C-]") nil)
      (define-key evil-motion-state-map (kbd "C-t") nil)

      (define-key evil-motion-state-map "\C-]"  'lsp-bridge-jump)
      (define-key evil-motion-state-map "g\C-]" 'lsp-bridge-jump)

      (define-key evil-normal-state-map "\C-t"  'lsp-bridge-jump-back)
      (define-key evil-motion-state-map "g\C-t" 'lsp-bridge-jump-back)
       )

    ;; glolal
    (global-set-key (kbd "M-]")   'dumb-jump-go)
    (global-set-key (kbd "M-t")   'dumb-jump-back)
    (global-set-key (kbd "M-n")   'hold-line-scroll-up)
    (global-set-key (kbd "M-p")   'hold-line-scroll-down)
    (global-set-key (kbd "C-6")   'lsp-bridge-popup-documentation)
    (global-set-key (kbd "C-7")   'lsp-bridge-jump-back) 
    (global-set-key (kbd "C-8")   'lsp-bridge-jump) 
    (global-set-key (kbd "M-,")   'lsp-bridge-jump-back) 
    (global-set-key (kbd "M-.")   'lsp-bridge-jump) 
    (global-set-key (kbd "C-9")   'lsp-bridge-find-references) 
    (global-set-key (kbd "C-0")   'lsp-bridge-rename) 
    (global-set-key (kbd "M-s-j") 'lsp-bridge-diagnostic-jump-next) ;æ˜¾ç¤ºä¸‹ä¸€ä¸ªé”™è¯¯ 
    (global-set-key (kbd "M-s-k") 'lsp-bridge-diagnostic-jump-prev) ;æ˜¾ç¤ºä¸Šä¸€ä¸ªé”™è¯¯) 
    (global-set-key (kbd "M-s-l") 'lsp-bridge-diagnostic-ignore) ;å¿½ç•¥å½“å‰çš„é”™è¯¯
    (global-set-key (kbd "M-s-n") 'lsp-bridge-popup-documentation-scroll-up) ;å‘ä¸‹æ»šåŠ¨æ–‡æ¡£
    (global-set-key (kbd "M-s-p") 'lsp-bridge-popup-documentation-scroll-down) ;å‘ä¸Šæ»šåŠ¨æ–‡æ¡£
    (global-set-key (kbd "C-x y") 'dash-at-point)


#+END_SRC
  
